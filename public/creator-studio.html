<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A402 Creator Studio · Apertum</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Sora:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- js-sha3 for keccak256 (function selectors + ABI encoding) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha3/0.9.3/sha3.min.js"></script>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #060709;
      --bg-raised: #0b0d13;
      --bg-panel: #0f1219;
      --bg-input: #131720;
      --bg-hover: #161b26;
      --border: #1c2233;
      --border-light: #242d40;
      --border-focus: #3272e8;
      --text: #b8bfce;
      --text-dim: #5c6478;
      --text-bright: #eaf0f9;
      --text-muted: #3a4052;
      --blue: #3272e8;
      --blue-light: #5a94f5;
      --blue-glow: rgba(50, 114, 232, 0.12);
      --blue-dim: rgba(50, 114, 232, 0.06);
      --green: #22c55e;
      --green-glow: rgba(34, 197, 94, 0.1);
      --amber: #eab308;
      --amber-glow: rgba(234, 179, 8, 0.08);
      --red: #ef4444;
      --red-glow: rgba(239, 68, 68, 0.08);
      --violet: #8b5cf6;
      --violet-glow: rgba(139, 92, 246, 0.08);
      --r: 10px;
      --r-lg: 14px;
      --r-xl: 18px;
      --mono: 'JetBrains Mono', monospace;
      --sans: 'Sora', system-ui, sans-serif;
      --ease: cubic-bezier(0.4, 0, 0.2, 1);
    }

    html { scroll-behavior: smooth; }
    body {
      background: var(--bg); color: var(--text);
      font-family: var(--sans); min-height: 100vh;
      line-height: 1.6; -webkit-font-smoothing: antialiased;
    }

    /* ── Ambient background ── */
    .ambient { position: fixed; inset: 0; z-index: 0; pointer-events: none; overflow: hidden; }
    .ambient .orb {
      position: absolute; border-radius: 50%; filter: blur(100px); opacity: 0.07;
      animation: orb-drift 22s ease-in-out infinite alternate;
    }
    .ambient .orb.o1 { width: 700px; height: 700px; top: -300px; left: -200px; background: var(--blue); }
    .ambient .orb.o2 { width: 500px; height: 500px; bottom: -200px; right: -150px; background: var(--violet); animation-delay: -8s; }
    @keyframes orb-drift { to { transform: translate(50px, -40px) scale(1.1); } }

    /* ── Shell ── */
    .shell { position: relative; z-index: 1; display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }

    /* ── Sidebar ── */
    .sidebar {
      background: var(--bg-raised); border-right: 1px solid var(--border);
      padding: 24px 16px; display: flex; flex-direction: column;
      position: sticky; top: 0; height: 100vh; overflow-y: auto;
    }
    .sb-brand { display: flex; align-items: center; gap: 11px; margin-bottom: 32px; padding: 0 8px; }
    .sb-mark {
      width: 34px; height: 34px; border-radius: 9px;
      background: linear-gradient(135deg, var(--blue), var(--violet));
      display: grid; place-items: center;
      font-family: var(--mono); font-weight: 600; font-size: 14px; color: #fff;
    }
    .sb-name { font-size: 13px; font-weight: 600; color: var(--text-bright); }
    .sb-name small { display: block; font-size: 10px; font-weight: 400; color: var(--text-dim); font-family: var(--mono); margin-top: 1px; }

    .sb-section { margin-bottom: 24px; }
    .sb-label {
      font-family: var(--mono); font-size: 9.5px; font-weight: 500;
      text-transform: uppercase; letter-spacing: 1.6px;
      color: var(--text-muted); margin-bottom: 8px; padding-left: 10px;
    }
    .sb-item {
      display: flex; align-items: center; gap: 9px;
      padding: 9px 10px; border-radius: 8px;
      font-size: 12.5px; color: var(--text-dim);
      cursor: pointer; transition: all 0.15s var(--ease);
      border: 1px solid transparent; user-select: none;
    }
    .sb-item:hover { color: var(--text); background: rgba(255,255,255,0.015); }
    .sb-item.active { color: var(--text-bright); background: var(--blue-glow); border-color: rgba(50,114,232,0.12); }
    .sb-item.disabled { opacity: 0.35; cursor: default; pointer-events: none; }
    .sb-item svg { width: 17px; height: 17px; stroke: currentColor; fill: none; stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round; flex-shrink: 0; }
    .sb-badge {
      margin-left: auto; font-family: var(--mono); font-size: 9px;
      padding: 2px 6px; border-radius: 8px;
      background: var(--blue-dim); color: var(--blue-light);
    }

    .sb-footer { margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border); }
    .sb-wallet {
      padding: 10px; border-radius: 8px;
      background: var(--green-glow); border: 1px solid rgba(34,197,94,0.1);
      font-family: var(--mono); font-size: 10.5px; color: var(--text-dim);
      display: none; flex-direction: column; gap: 4px;
    }
    .sb-wallet.show { display: flex; }
    .sb-wallet .addr { color: var(--green); font-weight: 500; }
    .sb-wallet .vault-addr { color: var(--text-dim); word-break: break-all; }
    .sb-chain {
      display: flex; align-items: center; gap: 7px;
      padding: 9px 10px; font-family: var(--mono); font-size: 10px; color: var(--text-dim);
    }
    .sb-chain-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); animation: pulse 2.5s ease infinite; }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.3; } }

    /* ── Main ── */
    .main { padding: 32px 40px 80px; overflow-y: auto; }

    /* ── Page views ── */
    .page { display: none; animation: pageIn 0.3s ease; }
    .page.active { display: block; }
    @keyframes pageIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .page-title { font-size: 24px; font-weight: 700; color: var(--text-bright); letter-spacing: -0.3px; margin-bottom: 6px; }
    .page-desc { font-size: 13px; color: var(--text-dim); margin-bottom: 32px; max-width: 560px; }

    /* ── Cards ── */
    .card {
      background: var(--bg-panel); border: 1px solid var(--border);
      border-radius: var(--r-lg); padding: 28px; margin-bottom: 20px;
    }
    .card-head { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
    .card-icon {
      width: 28px; height: 28px; border-radius: 7px;
      display: grid; place-items: center;
      background: var(--blue-glow); border: 1px solid rgba(50,114,232,0.1);
    }
    .card-icon svg { width: 14px; height: 14px; stroke: var(--blue-light); fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    .card-icon.green { background: var(--green-glow); border-color: rgba(34,197,94,0.1); }
    .card-icon.green svg { stroke: var(--green); }
    .card-icon.violet { background: var(--violet-glow); border-color: rgba(139,92,246,0.1); }
    .card-icon.violet svg { stroke: var(--violet); }
    .card-icon.amber { background: var(--amber-glow); border-color: rgba(234,179,8,0.1); }
    .card-icon.amber svg { stroke: var(--amber); }
    .card h2 { font-size: 15px; font-weight: 600; color: var(--text-bright); }
    .card .sub { font-size: 12px; color: var(--text-dim); margin-bottom: 22px; }

    /* ── Form fields ── */
    .field { margin-bottom: 18px; }
    .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .field label {
      display: block; font-size: 11px; font-weight: 500; color: var(--text);
      font-family: var(--mono); margin-bottom: 6px; letter-spacing: 0.2px;
    }
    .field label .req { color: var(--red); }
    .field label .hint { display: block; font-family: var(--sans); font-weight: 300; font-size: 11px; color: var(--text-dim); margin-top: 1px; }
    .field input, .field select, .field textarea {
      width: 100%; padding: 10px 13px;
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text-bright);
      font-family: var(--mono); font-size: 12.5px;
      transition: all 0.15s var(--ease); outline: none;
    }
    .field input::placeholder, .field textarea::placeholder { color: var(--text-muted); }
    .field input:focus, .field textarea:focus { border-color: var(--border-focus); box-shadow: 0 0 0 3px var(--blue-glow); }
    .field textarea { resize: vertical; min-height: 72px; font-family: var(--sans); font-size: 12.5px; line-height: 1.5; }
    .field select { cursor: pointer; appearance: none; }
    .field .input-with-tag { display: grid; grid-template-columns: 1fr auto; gap: 0; }
    .field .input-tag {
      padding: 10px 14px; background: var(--bg-input); border: 1px solid var(--border);
      border-left: none; border-radius: 0 8px 8px 0;
      font-family: var(--mono); font-size: 12px; color: var(--blue-light); font-weight: 500;
      display: flex; align-items: center;
    }
    .field .input-with-tag input { border-radius: 8px 0 0 8px; }

    /* ── Thumbnail preview ── */
    .thumb-preview {
      max-width: 420px; aspect-ratio: 16/9; border-radius: var(--r);
      background: #0a0a0a; border: 1px solid var(--border);
      overflow: hidden; position: relative; margin-bottom: 18px;
      display: flex; align-items: center; justify-content: center;
    }
    .thumb-preview img { width: 100%; height: 100%; object-fit: cover; }
    .thumb-preview .placeholder { font-size: 12px; color: var(--text-muted); font-family: var(--mono); text-align: center; padding: 20px; }

    /* ── Toggle ── */
    .type-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
    .type-option {
      display: flex; flex-direction: column; align-items: center; gap: 8px;
      padding: 18px 12px; border-radius: var(--r); cursor: pointer;
      background: var(--bg-input); border: 2px solid var(--border);
      transition: all 0.2s var(--ease); user-select: none; text-align: center;
    }
    .type-option:hover { border-color: var(--border-light); background: var(--bg-hover); }
    .type-option.selected { border-color: var(--blue); background: var(--blue-glow); }
    .type-option svg { width: 28px; height: 28px; stroke: var(--text-dim); fill: none; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; transition: stroke 0.15s; }
    .type-option.selected svg { stroke: var(--blue-light); }
    .type-option .type-label { font-size: 12px; font-weight: 600; color: var(--text-dim); transition: color 0.15s; }
    .type-option.selected .type-label { color: var(--text-bright); }
    .type-option .type-hint { font-size: 10px; color: var(--text-muted); font-family: var(--mono); }
    .type-option.selected .type-hint { color: var(--text-dim); }

    /* ── Toggle ── */
    .toggle-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 16px; border-radius: var(--r);
      background: var(--bg-input); border: 1px solid var(--border);
      cursor: pointer; transition: all 0.15s var(--ease); user-select: none;
    }
    .toggle-row:hover { border-color: var(--border-light); }
    .toggle-info { font-size: 12.5px; color: var(--text); }
    .toggle-info small { display: block; font-size: 11px; color: var(--text-dim); margin-top: 2px; }
    .toggle-track {
      width: 40px; height: 22px; border-radius: 11px;
      background: var(--border); position: relative;
      transition: background 0.2s var(--ease); flex-shrink: 0;
    }
    .toggle-track::after {
      content: ''; position: absolute; top: 3px; left: 3px;
      width: 16px; height: 16px; border-radius: 50%;
      background: #fff; transition: transform 0.2s var(--ease);
    }
    .toggle-row.on .toggle-track { background: var(--green); }
    .toggle-row.on .toggle-track::after { transform: translateX(18px); }

    /* ── Buttons ── */
    .btn {
      padding: 11px 22px; border-radius: var(--r); border: none;
      font-family: var(--sans); font-size: 12.5px; font-weight: 600;
      cursor: pointer; transition: all 0.15s var(--ease);
      display: inline-flex; align-items: center; gap: 8px;
    }
    .btn svg { width: 15px; height: 15px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    .btn-primary { background: linear-gradient(135deg, var(--blue), #4a6af5); color: #fff; box-shadow: 0 4px 18px var(--blue-glow); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(50,114,232,0.2); }
    .btn-secondary { background: var(--bg-input); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { border-color: var(--border-light); color: var(--text-bright); }
    .btn-green { background: var(--green); color: #000; }
    .btn-green:hover { filter: brightness(1.1); }
    .btn-red { background: rgba(239,68,68,0.1); color: var(--red); border: 1px solid rgba(239,68,68,0.15); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }
    .btn-sm { padding: 7px 14px; font-size: 11px; }
    .btn-row { display: flex; gap: 10px; margin-top: 24px; flex-wrap: wrap; }
    .spinner { width: 15px; height: 15px; border: 2px solid rgba(255,255,255,0.2); border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Wizard steps ── */
    .wiz-bar { display: flex; gap: 4px; margin-bottom: 28px; }
    .wiz-seg {
      flex: 1; height: 3px; border-radius: 2px;
      background: var(--border); transition: background 0.3s;
    }
    .wiz-seg.done { background: var(--green); }
    .wiz-seg.current { background: var(--blue); }

    /* ── Status ── */
    .status-bar {
      padding: 12px 16px; border-radius: var(--r);
      font-family: var(--mono); font-size: 12px; line-height: 1.5;
      margin-top: 16px; display: none;
    }
    .status-bar.show { display: block; animation: pageIn 0.25s ease; }
    .status-bar.info { background: var(--blue-glow); border: 1px solid rgba(50,114,232,0.12); color: var(--blue-light); }
    .status-bar.success { background: var(--green-glow); border: 1px solid rgba(34,197,94,0.12); color: var(--green); }
    .status-bar.error { background: var(--red-glow); border: 1px solid rgba(239,68,68,0.12); color: var(--red); }
    .status-bar.pending { background: var(--amber-glow); border: 1px solid rgba(234,179,8,0.12); color: var(--amber); }
    .status-bar a { color: inherit; }

    /* ── Connect screen ── */
    .connect-screen {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; min-height: 60vh; text-align: center;
    }
    .connect-icon {
      width: 80px; height: 80px; border-radius: 20px;
      background: linear-gradient(135deg, var(--blue-glow), var(--violet-glow));
      border: 1px solid rgba(50,114,232,0.1);
      display: grid; place-items: center; margin-bottom: 24px;
    }
    .connect-icon svg { width: 36px; height: 36px; stroke: var(--blue-light); fill: none; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; }
    .connect-screen h1 { font-size: 26px; font-weight: 700; color: var(--text-bright); margin-bottom: 8px; }
    .connect-screen p { font-size: 14px; color: var(--text-dim); max-width: 400px; margin-bottom: 28px; }

    /* ── Stats grid ── */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 14px; margin-bottom: 24px; }
    .stat-card {
      padding: 20px; border-radius: var(--r-lg);
      background: var(--bg-panel); border: 1px solid var(--border);
    }
    .stat-label { font-family: var(--mono); font-size: 10px; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text-dim); margin-bottom: 8px; }
    .stat-value { font-family: var(--mono); font-size: 22px; font-weight: 600; color: var(--text-bright); }
    .stat-value .unit { font-size: 12px; font-weight: 400; color: var(--blue-light); margin-left: 3px; }
    .stat-card.highlight { border-color: rgba(34,197,94,0.15); background: rgba(34,197,94,0.03); }
    .stat-card.highlight .stat-value { color: var(--green); }

    /* ── Resource list ── */
    .res-list { display: flex; flex-direction: column; gap: 12px; }
    .res-item {
      padding: 18px 20px; border-radius: var(--r-lg);
      background: var(--bg-panel); border: 1px solid var(--border);
      display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: center;
      transition: border-color 0.15s var(--ease);
    }
    .res-item:hover { border-color: var(--border-light); }
    .res-meta { display: flex; flex-direction: column; gap: 6px; }
    .res-title-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .res-id { font-family: var(--mono); font-size: 14px; font-weight: 600; color: var(--text-bright); }
    .res-badge {
      font-family: var(--mono); font-size: 9.5px; padding: 3px 8px;
      border-radius: 5px; font-weight: 500;
    }
    .res-badge.video { background: var(--blue-dim); color: var(--blue-light); border: 1px solid rgba(50,114,232,0.1); }
    .res-badge.article { background: var(--violet-glow); color: var(--violet); border: 1px solid rgba(139,92,246,0.1); }
    .res-badge.file { background: var(--amber-glow); color: var(--amber); border: 1px solid rgba(234,179,8,0.1); }
    .res-badge.api { background: rgba(6,182,212,0.08); color: #06b6d4; border: 1px solid rgba(6,182,212,0.1); }
    .res-badge.lifetime { background: var(--green-glow); color: var(--green); border: 1px solid rgba(34,197,94,0.1); }
    .res-badge.per-access { background: var(--amber-glow); color: var(--amber); border: 1px solid rgba(234,179,8,0.1); }
    .res-badge.active { background: var(--green-glow); color: var(--green); border: 1px solid rgba(34,197,94,0.1); }
    .res-badge.paused { background: var(--red-glow); color: var(--red); border: 1px solid rgba(239,68,68,0.1); }
    .res-stats { font-family: var(--mono); font-size: 11px; color: var(--text-dim); display: flex; gap: 16px; }
    .res-actions { display: flex; gap: 8px; flex-wrap: wrap; }

    /* ── Inline edit panel ── */
    .res-edit {
      grid-column: 1 / -1; padding-top: 16px; margin-top: 14px;
      border-top: 1px solid var(--border); display: none;
      animation: pageIn 0.2s ease;
    }
    .res-edit.open { display: block; }
    .res-edit .edit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; }
    .res-edit .edit-full { grid-column: 1 / -1; }
    .res-edit label {
      display: block; font-family: var(--mono); font-size: 10px; font-weight: 500;
      color: var(--text-dim); margin-bottom: 5px; letter-spacing: 0.2px;
    }
    .res-edit input {
      width: 100%; padding: 8px 11px;
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 6px; color: var(--text-bright);
      font-family: var(--mono); font-size: 12px;
      outline: none; transition: border-color 0.15s;
    }
    .res-edit input:focus { border-color: var(--border-focus); }
    .res-edit .edit-toggle {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 11px; border-radius: 6px;
      background: var(--bg-input); border: 1px solid var(--border);
      cursor: pointer; user-select: none;
    }
    .res-edit .edit-toggle span { font-family: var(--mono); font-size: 12px; color: var(--text); }
    .res-edit .mini-track {
      width: 32px; height: 18px; border-radius: 9px;
      background: var(--border); position: relative; transition: background 0.2s;
    }
    .res-edit .mini-track::after {
      content: ''; position: absolute; top: 2px; left: 2px;
      width: 14px; height: 14px; border-radius: 50%;
      background: #fff; transition: transform 0.2s;
    }
    .res-edit .edit-toggle.on .mini-track { background: var(--green); }
    .res-edit .edit-toggle.on .mini-track::after { transform: translateX(14px); }
    .res-edit .edit-actions { display: flex; gap: 8px; }
    .res-edit .edit-status {
      font-family: var(--mono); font-size: 11px; margin-top: 10px;
      padding: 8px 12px; border-radius: 6px; display: none;
    }
    .res-edit .edit-status.show { display: block; }
    .res-edit .edit-status.success { background: var(--green-glow); color: var(--green); border: 1px solid rgba(34,197,94,0.1); }
    .res-edit .edit-status.error { background: var(--red-glow); color: var(--red); border: 1px solid rgba(239,68,68,0.1); }
    .res-edit .edit-status.pending { background: var(--amber-glow); color: var(--amber); border: 1px solid rgba(234,179,8,0.1); }

    /* ── Embed dropdown ── */
    .embed-wrap { position: relative; }
    .embed-dropdown {
      display: none; position: absolute; right: 0; top: calc(100% + 6px);
      z-index: 20; width: 380px; max-width: 92vw;
      background: var(--bg-panel); border: 1px solid var(--border-light);
      border-radius: var(--r-lg); box-shadow: 0 12px 36px rgba(0,0,0,0.5);
      padding: 14px; animation: pageIn 0.15s ease;
    }
    .embed-dropdown.open { display: block; }
    .embed-dropdown .ed-title {
      font-family: var(--mono); font-size: 10px; font-weight: 500;
      text-transform: uppercase; letter-spacing: 1.2px;
      color: var(--text-dim); margin-bottom: 10px;
    }
    .embed-dropdown .ed-row {
      display: flex; align-items: center; justify-content: space-between;
      gap: 8px; margin-bottom: 8px;
    }
    .embed-dropdown .ed-row:last-child { margin-bottom: 0; }
    .embed-dropdown .ed-label {
      font-family: var(--mono); font-size: 11px; color: var(--text);
      white-space: nowrap; flex-shrink: 0;
    }
    .embed-dropdown .ed-label small { color: var(--text-dim); font-weight: 300; }
    .embed-dropdown .ed-copy {
      padding: 5px 10px; border-radius: 5px;
      background: var(--bg-input); border: 1px solid var(--border);
      font-family: var(--mono); font-size: 10px; color: var(--text-dim);
      cursor: pointer; white-space: nowrap; transition: all 0.15s var(--ease);
    }
    .embed-dropdown .ed-copy:hover { border-color: var(--blue); color: var(--blue-light); }
    .embed-dropdown .ed-copy.copied { border-color: var(--green); color: var(--green); }
    .embed-dropdown .ed-preview {
      margin-top: 10px; padding: 8px 10px;
      background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px;
      font-family: var(--mono); font-size: 10.5px; color: var(--text-dim);
      line-height: 1.6; white-space: pre-wrap; word-break: break-all;
      max-height: 72px; overflow-y: auto; display: none;
    }
    .embed-dropdown .ed-preview.show { display: block; }

    /* ── Embed code block ── */
    .code-block {
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: var(--r); overflow: hidden; margin-top: 12px;
    }
    .code-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 14px; background: rgba(255,255,255,0.01);
      border-bottom: 1px solid var(--border);
      font-family: var(--mono); font-size: 10px; color: var(--text-dim);
    }
    .code-header .copy-btn {
      background: none; border: 1px solid var(--border); border-radius: 4px;
      padding: 3px 8px; font-family: var(--mono); font-size: 9px;
      color: var(--text-dim); cursor: pointer;
    }
    .code-header .copy-btn:hover { border-color: var(--blue); color: var(--blue-light); }
    .code-block pre {
      padding: 14px; font-family: var(--mono); font-size: 11.5px;
      color: var(--text); line-height: 1.7; overflow-x: auto; white-space: pre-wrap; word-break: break-all;
    }

    /* ── Empty state ── */
    .empty-state {
      text-align: center; padding: 48px 20px;
      border: 1px dashed var(--border); border-radius: var(--r-lg);
    }
    .empty-state p { font-size: 13px; color: var(--text-dim); margin-bottom: 16px; }

    /* ── Revenue chart ── */
    .chart-wrap {
      position: relative; width: 100%; height: 220px;
      margin-top: 8px; margin-bottom: 4px;
    }
    .chart-wrap canvas { display: block; width: 100%; height: 100%; }
    .chart-empty {
      display: flex; align-items: center; justify-content: center;
      height: 100%; font-family: var(--mono); font-size: 12px; color: var(--text-muted);
    }
    .chart-legend {
      display: flex; gap: 16px; flex-wrap: wrap;
      font-family: var(--mono); font-size: 10px; color: var(--text-dim); margin-top: 6px;
    }
    .chart-legend .dot {
      display: inline-block; width: 8px; height: 8px; border-radius: 2px; margin-right: 5px;
      vertical-align: middle;
    }

    /* ── Date filter bar ── */
    .filter-bar {
      display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
      margin-bottom: 14px;
    }
    .filter-chip {
      padding: 5px 12px; border-radius: 6px;
      font-family: var(--mono); font-size: 10.5px; font-weight: 500;
      background: var(--bg-input); border: 1px solid var(--border);
      color: var(--text-dim); cursor: pointer;
      transition: all 0.15s var(--ease); user-select: none;
    }
    .filter-chip:hover { border-color: var(--border-light); color: var(--text); }
    .filter-chip.active { background: var(--blue-glow); border-color: rgba(50,114,232,0.2); color: var(--blue-light); }
    .filter-spacer { flex: 1; }

    /* ── Transaction table ── */
    .tx-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    .tx-table th {
      font-family: var(--mono); font-size: 9.5px; font-weight: 500;
      text-transform: uppercase; letter-spacing: 1px;
      color: var(--text-muted); text-align: left;
      padding: 8px 10px; border-bottom: 1px solid var(--border);
    }
    .tx-table td {
      font-family: var(--mono); font-size: 12px; color: var(--text);
      padding: 10px 10px; border-bottom: 1px solid rgba(28,34,51,0.5);
      vertical-align: middle;
    }
    .tx-table tr:hover td { background: rgba(255,255,255,0.01); }
    .tx-table .addr { color: var(--blue-light); text-decoration: none; }
    .tx-table .addr:hover { text-decoration: underline; }
    .tx-table .amt { color: var(--text-bright); font-weight: 500; }
    .tx-table .res-tag {
      font-size: 10px; padding: 2px 6px; border-radius: 4px;
      background: var(--blue-dim); color: var(--blue-light); border: 1px solid rgba(50,114,232,0.1);
    }
    .tx-table .time { color: var(--text-dim); font-size: 11px; }
    .tx-empty {
      text-align: center; padding: 28px 16px;
      font-family: var(--mono); font-size: 12px; color: var(--text-muted);
    }
    .tx-pagination {
      display: flex; align-items: center; justify-content: space-between;
      margin-top: 10px; font-family: var(--mono); font-size: 10px; color: var(--text-dim);
    }
    .tx-pagination button {
      padding: 4px 10px; border-radius: 5px;
      background: var(--bg-input); border: 1px solid var(--border);
      font-family: var(--mono); font-size: 10px; color: var(--text-dim);
      cursor: pointer; transition: all 0.15s var(--ease);
    }
    .tx-pagination button:hover:not(:disabled) { border-color: var(--border-light); color: var(--text); }
    .tx-pagination button:disabled { opacity: 0.3; cursor: not-allowed; }

    /* ── Responsive ── */
    @media (max-width: 860px) {
      .shell { grid-template-columns: 1fr; }
      .sidebar { position: relative; height: auto; flex-direction: row; flex-wrap: wrap; padding: 14px; gap: 8px; }
      .sb-section, .sb-footer { display: none; }
      .main { padding: 20px 16px 60px; }
      .field-row { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .res-item { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="ambient"><div class="orb o1"></div><div class="orb o2"></div></div>

  <div class="shell">
    <!-- ═══ SIDEBAR ═══ -->
    <aside class="sidebar">
      <div class="sb-brand">
        <div class="sb-mark">A</div>
        <div class="sb-name">Creator Studio<small>A402 · Apertum</small></div>
      </div>

      <div class="sb-section">
        <div class="sb-label">Dashboard</div>
        <div class="sb-item active" data-page="add-content" onclick="showPage('add-content')">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
          Add Content
        </div>
        <div class="sb-item" data-page="my-content" onclick="showPage('my-content')">
          <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
          My Content
          <span class="sb-badge" id="contentCount">0</span>
        </div>
        <div class="sb-item" data-page="revenue" onclick="showPage('revenue')">
          <svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          Revenue
        </div>
      </div>

      <div class="sb-footer">
        <div class="sb-wallet" id="sidebarWallet">
          <span class="addr" id="sidebarAddr"></span>
          <span class="vault-addr" id="sidebarVault"></span>
        </div>
        <div class="sb-chain"><div class="sb-chain-dot"></div> eip155:2786 · Apertum</div>
      </div>
    </aside>

    <!-- ═══ MAIN ═══ -->
    <main class="main" id="mainContent">

      <!-- ── CONNECT SCREEN ── -->
      <div class="page active" id="page-connect">
        <div class="connect-screen">
          <div class="connect-icon">
            <svg viewBox="0 0 24 24"><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"/><circle cx="18" cy="16" r="2"/></svg>
          </div>
          <h1>Welcome to Creator Studio</h1>
          <p>Connect your wallet to create a vault and start monetizing your content on Apertum.</p>
          <button class="btn btn-primary" onclick="connectWallet()" id="connectBtn">
            <svg viewBox="0 0 24 24"><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"/><circle cx="18" cy="16" r="2"/></svg>
            Connect Wallet
          </button>
          <div class="status-bar" id="connectStatus"></div>
        </div>
      </div>

      <!-- ── VAULT CREATION SCREEN ── -->
      <div class="page" id="page-create-vault">
        <div class="connect-screen">
          <div class="connect-icon" style="background: linear-gradient(135deg, var(--green-glow), var(--blue-glow));">
            <svg viewBox="0 0 24 24" style="stroke: var(--green);"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          </div>
          <h1>Create Your Vault</h1>
          <p>Your vault is your on-chain identity on A402. It's a smart contract that receives payments and tracks your content. One-time setup, costs ~0.002 APTM.</p>
          <button class="btn btn-green" onclick="createVault()" id="createVaultBtn">
            <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            Create Vault (~0.002 APTM)
          </button>
          <div class="status-bar" id="vaultStatus"></div>
        </div>
      </div>

      <!-- ── ADD CONTENT ── -->
      <div class="page" id="page-add-content">
        <h1 class="page-title">Add Content</h1>
        <p class="page-desc">Publish paid content on-chain. Choose a type, set your price, and one transaction makes it live.</p>

        <div class="wiz-bar">
          <div class="wiz-seg current" id="wiz0"></div>
          <div class="wiz-seg" id="wiz1"></div>
          <div class="wiz-seg" id="wiz2"></div>
        </div>

        <!-- Step 0: Content -->
        <div id="addStep0">
          <div class="card">
            <div class="card-head">
              <div class="card-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg></div>
              <h2>Content Type & Details</h2>
            </div>
            <p class="sub">What kind of content are you publishing?</p>

            <div class="type-selector" id="typeSelector">
              <div class="type-option selected" data-type="video" onclick="selectContentType('video')">
                <svg viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>
                <span class="type-label">Video</span>
                <span class="type-hint">YouTube · IPFS · URL</span>
              </div>
              <div class="type-option" data-type="article" onclick="selectContentType('article')">
                <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                <span class="type-label">Article</span>
                <span class="type-hint">Markdown · HTML</span>
              </div>
              <div class="type-option" data-type="file" onclick="selectContentType('file')">
                <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                <span class="type-label">File</span>
                <span class="type-hint">PDF · ZIP · Dataset</span>
              </div>
              <div class="type-option" data-type="api" onclick="selectContentType('api')">
                <svg viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                <span class="type-label">API</span>
                <span class="type-hint">Endpoint · Token</span>
              </div>
            </div>

            <!-- Dynamic fields per type -->
            <div id="typeFields">
              <!-- Video fields (default) -->
              <div id="fieldsVideo">
                <div class="field">
                  <label>Video Source <span class="req">*</span>
                    <span class="hint">YouTube link, IPFS URL (ipfs://...), gateway URL, or direct video URL (.mp4, .webm)</span>
                  </label>
                  <input type="text" id="ytInput" placeholder="YouTube URL, ipfs://Qm..., or https://example.com/video.mp4" oninput="parseContentInput()">
                </div>
                <div class="thumb-preview" id="thumbPreview">
                  <div class="placeholder">Video preview will appear here</div>
                </div>
              </div>

              <!-- Article fields -->
              <div id="fieldsArticle" style="display:none;">
                <div class="field">
                  <label>Article Source <span class="req">*</span>
                    <span class="hint">IPFS hash of markdown/HTML, or a direct URL to the content</span>
                  </label>
                  <input type="text" id="articleInput" placeholder="ipfs://Qm... or https://example.com/article.md" oninput="parseContentInput()">
                </div>
                <div class="thumb-preview" id="articlePreview">
                  <div class="placeholder" style="display:flex;flex-direction:column;align-items:center;gap:8px;">
                    <svg viewBox="0 0 24 24" style="width:36px;height:36px;stroke:var(--violet);fill:none;stroke-width:1.5;opacity:0.5;">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    Article source preview
                  </div>
                </div>
              </div>

              <!-- File fields -->
              <div id="fieldsFile" style="display:none;">
                <div class="field">
                  <label>File Location <span class="req">*</span>
                    <span class="hint">IPFS hash or hosted URL to the downloadable file (PDF, ZIP, dataset, etc.)</span>
                  </label>
                  <input type="text" id="fileInput" placeholder="ipfs://Qm... or https://example.com/report.pdf" oninput="parseContentInput()">
                </div>
                <div class="field">
                  <label>File Name
                    <span class="hint">Display name for the download (e.g. "Q4 Report.pdf"). Optional — derived from URL if blank.</span>
                  </label>
                  <input type="text" id="fileNameInput" placeholder="report.pdf">
                </div>
              </div>

              <!-- API fields -->
              <div id="fieldsApi" style="display:none;">
                <div class="field">
                  <label>API Endpoint <span class="req">*</span>
                    <span class="hint">The base URL of the API. After payment, a signed token is shown to the buyer.</span>
                  </label>
                  <input type="text" id="apiInput" placeholder="https://api.example.com/v1/data" oninput="parseContentInput()">
                </div>
                <div class="field">
                  <label>API Description
                    <span class="hint">Short description of what the API provides. Shown to buyers before purchase.</span>
                  </label>
                  <textarea id="apiDescInput" rows="2" placeholder="Real-time market data feed with 1-minute candles..."></textarea>
                </div>
              </div>
            </div>

            <div class="field">
              <label>Resource ID <span class="req">*</span>
                <span class="hint">Unique on-chain identifier (auto-generated, editable)</span>
              </label>
              <input type="text" id="resId" placeholder="video-001">
            </div>

            <div class="btn-row">
              <button class="btn btn-primary" onclick="addStep(1)">
                Continue
                <svg viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Step 1: Pricing -->
        <div id="addStep1" style="display:none;">
          <div class="card">
            <div class="card-head">
              <div class="card-icon green"><svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
              <h2>Pricing & Access</h2>
            </div>
            <p class="sub">Set the price. The contract enforces it — no one can pay less.</p>

            <div class="field">
              <label>Price <span class="req">*</span></label>
              <div class="input-with-tag">
                <input type="number" id="priceInput" value="0.001" min="0.0001" step="0.0001">
                <div class="input-tag">APTM</div>
              </div>
            </div>

            <div class="field">
              <div class="toggle-row on" id="lifetimeToggle" onclick="toggleLifetime()">
                <div class="toggle-info">
                  Lifetime Access
                  <small>Viewers pay once and get permanent on-chain access</small>
                </div>
                <div class="toggle-track"></div>
              </div>
            </div>

            <!-- V2: Token Pricing (shown only if vault is V2+) -->
            <div id="tokenPricingSection" style="display:none;">
              <div style="margin-top:8px; margin-bottom:14px; padding-top:16px; border-top:1px solid var(--border);">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                  <span style="font-family:var(--mono); font-size:11px; font-weight:500; color:var(--text); letter-spacing:0.2px;">ERC-20 TOKEN PRICING</span>
                  <span style="font-family:var(--mono); font-size:9px; padding:2px 6px; border-radius:4px; background:rgba(139,92,246,0.08); color:#8b5cf6; border:1px solid rgba(139,92,246,0.1);">V2</span>
                </div>
                <p style="font-size:11px; color:var(--text-dim); margin-bottom:14px;">
                  Optionally set prices in ERC-20 tokens. Viewers can pay with APTM or any token you price below.
                </p>
                <div id="tokenPriceInputs"></div>
              </div>
            </div>

            <div class="btn-row">
              <button class="btn btn-secondary" onclick="addStep(0)">
                <svg viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                Back
              </button>
              <button class="btn btn-primary" onclick="addStep(2)">
                Review & Publish
                <svg viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Step 2: Review & Publish -->
        <div id="addStep2" style="display:none;">
          <div class="card">
            <div class="card-head">
              <div class="card-icon amber"><svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div>
              <h2>Review & Publish</h2>
            </div>
            <p class="sub">Confirm the details. Publishing calls <code>vault.addResource()</code> on-chain.</p>

            <div class="thumb-preview" id="reviewThumb">
              <div class="placeholder">—</div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:18px;">
              <div class="stat-card">
                <div class="stat-label">Resource ID</div>
                <div class="stat-value" id="reviewResId" style="font-size:14px;">—</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Content Type</div>
                <div class="stat-value" id="reviewType" style="font-size:14px;">—</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Price</div>
                <div class="stat-value" id="reviewPrice" style="font-size:14px;">—</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Access</div>
                <div class="stat-value" id="reviewAccess" style="font-size:14px;">—</div>
              </div>
              <div class="stat-card" style="grid-column:1/-1;">
                <div class="stat-label">Content Source</div>
                <div class="stat-value" id="reviewYtId" style="font-size:14px;word-break:break-all;">—</div>
              </div>
              <div class="stat-card" style="grid-column:1/-1;">
                <div class="stat-label">Estimated Gas Cost</div>
                <div class="stat-value" id="reviewGas" style="font-size:14px;">Estimating...</div>
              </div>
              <div class="stat-card" id="reviewTokenPricesCard" style="grid-column:1/-1; display:none;">
                <div class="stat-label">Token Prices (V2)</div>
                <div class="stat-value" id="reviewTokenPrices" style="font-size:13px;">—</div>
              </div>
            </div>

            <div class="btn-row">
              <button class="btn btn-secondary" onclick="addStep(1)">
                <svg viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
                Back
              </button>
              <button class="btn btn-green" onclick="publishResource()" id="publishBtn">
                <svg viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                Publish On-Chain
              </button>
            </div>
            <div class="status-bar" id="publishStatus"></div>

            <!-- Embed codes shown after publish -->
            <div id="embedOutput" style="display:none; margin-top:24px;">
              <h2 style="font-size:14px; color:var(--text-bright); margin-bottom:12px;">Your Embed Codes</h2>
              <div class="code-block">
                <div class="code-header"><span>Hosted Link</span><button class="copy-btn" onclick="copyText('embedLink')">Copy</button></div>
                <pre id="embedLink"></pre>
              </div>
              <div class="code-block">
                <div class="code-header"><span>iframe Embed</span><button class="copy-btn" onclick="copyText('embedIframe')">Copy</button></div>
                <pre id="embedIframe"></pre>
              </div>
              <div class="code-block">
                <div class="code-header"><span>Script Embed</span><button class="copy-btn" onclick="copyText('embedScript')">Copy</button></div>
                <pre id="embedScript"></pre>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ── MY CONTENT ── -->
      <div class="page" id="page-my-content">
        <h1 class="page-title">My Content</h1>
        <p class="page-desc">All resources registered in your vault. Data is read directly from the blockchain.</p>
        <div id="contentList">
          <div class="empty-state">
            <p>Loading resources from your vault...</p>
          </div>
        </div>
      </div>

      <!-- ── REVENUE ── -->
      <div class="page" id="page-revenue">
        <h1 class="page-title">Revenue</h1>
        <p class="page-desc">Earnings from your vault. All numbers come directly from on-chain data.</p>

        <div class="stats-grid" id="revenueStats">
          <div class="stat-card highlight">
            <div class="stat-label">Available Balance</div>
            <div class="stat-value" id="statBalance">—<span class="unit">APTM</span></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Revenue</div>
            <div class="stat-value" id="statRevenue">—<span class="unit">APTM</span></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Withdrawn</div>
            <div class="stat-value" id="statWithdrawn">—<span class="unit">APTM</span></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Resources</div>
            <div class="stat-value" id="statResources">—</div>
          </div>
        </div>

        <!-- Revenue Chart -->
        <div class="card">
          <div class="card-head">
            <div class="card-icon"><svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
            <h2>Revenue Over Time</h2>
          </div>
          <p class="sub">Payment activity from on-chain event logs.</p>
          <div class="filter-bar" id="chartFilterBar">
            <span class="filter-chip active" data-range="7" onclick="setChartRange(7,this)">7d</span>
            <span class="filter-chip" data-range="30" onclick="setChartRange(30,this)">30d</span>
            <span class="filter-chip" data-range="90" onclick="setChartRange(90,this)">90d</span>
            <span class="filter-chip" data-range="0" onclick="setChartRange(0,this)">All</span>
            <div class="filter-spacer"></div>
            <span style="font-family:var(--mono);font-size:10px;color:var(--text-dim);" id="chartTxCount"></span>
          </div>
          <div class="chart-wrap" id="chartWrap">
            <div class="chart-empty" id="chartEmpty">Loading event logs...</div>
            <canvas id="revenueChart" style="display:none;"></canvas>
          </div>
          <div class="chart-legend" id="chartLegend" style="display:none;">
            <span><span class="dot" style="background:var(--blue-light);"></span>Revenue (APTM)</span>
            <span><span class="dot" style="background:var(--green);"></span>Payments</span>
          </div>
        </div>

        <!-- Recent Transactions -->
        <div class="card">
          <div class="card-head">
            <div class="card-icon amber"><svg viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg></div>
            <h2>Recent Transactions</h2>
          </div>
          <p class="sub">Individual payments from event logs. <button class="btn btn-sm btn-secondary" onclick="exportCSV()" id="csvBtn" style="margin-left:6px;padding:4px 10px;font-size:10px;" disabled>
            <svg viewBox="0 0 24 24" style="width:11px;height:11px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Export CSV
          </button></p>
          <div id="txTableWrap">
            <div class="tx-empty">Loading...</div>
          </div>
        </div>

        <div class="card">
          <div class="card-head">
            <div class="card-icon green"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></div>
            <h2>Withdraw</h2>
          </div>
          <p class="sub">Pull your accumulated earnings from the vault to your wallet.</p>
          <div class="btn-row" style="margin-top:0;">
            <button class="btn btn-green" onclick="withdrawAll()" id="withdrawBtn">
              <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Withdraw All
            </button>
          </div>
          <div class="status-bar" id="withdrawStatus"></div>
        </div>

        <div class="card">
          <div class="card-head">
            <div class="card-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg></div>
            <h2>Per-Resource Breakdown</h2>
          </div>
          <p class="sub">Revenue and payment counts for each resource.</p>
          <div id="revenueBreakdown" style="margin-top:8px;">
            <div style="font-family:var(--mono); font-size:12px; color:var(--text-dim);">Loading...</div>
          </div>
        </div>

        <div class="card">
          <div class="card-head">
            <div class="card-icon violet"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
            <h2>Vault Details</h2>
          </div>
          <p class="sub">Your on-chain vault contract.</p>
          <div style="font-family:var(--mono); font-size:12px; color:var(--text-dim); word-break:break-all;">
            <div style="margin-bottom:6px;">Vault: <a id="vaultLink" href="#" target="_blank" style="color:var(--blue-light); text-decoration:none;"></a></div>
            <div>Explorer: <a id="explorerLink" href="#" target="_blank" style="color:var(--blue-light); text-decoration:none;">View on Apertum Explorer</a></div>
          </div>
        </div>
      </div>

    </main>
  </div>

<script>
// ═══════════════════════════════════════════════════════════════
//  CONSTANTS
// ═══════════════════════════════════════════════════════════════

const FACTORY = '0x88408192d8548CD864f58E7d3c6f97fD577d4451';
const RPC = 'https://rpc.apertum.io/ext/bc/YDJ1r9RMkewATmA7B35q1bdV18aywzmdiXwd9zGBq3uQjsCnn/rpc';
const CHAIN_ID = 2786;
const CHAIN_HEX = '0x' + CHAIN_ID.toString(16);
const EXPLORER = 'https://explorer.apertum.io';

// ═══════════════════════════════════════════════════════════════
//  ABI ENCODING HELPERS
// ═══════════════════════════════════════════════════════════════

function selector(sig) { return keccak256(sig).slice(0, 8); }
function pad32(hex) { return hex.replace('0x','').padStart(64, '0'); }
function padAddr(a) { return pad32(a.replace('0x','').toLowerCase()); }
function padUint(n) { return BigInt(n).toString(16).padStart(64, '0'); }
function padBool(b) { return padUint(b ? 1 : 0); }

function encodeString(s) {
  const bytes = new TextEncoder().encode(s);
  const len = padUint(bytes.length);
  let hex = '';
  for (const b of bytes) hex += b.toString(16).padStart(2, '0');
  return len + hex.padEnd(Math.ceil(hex.length / 64) * 64, '0');
}

function toWei(aptm) {
  const s = aptm.toString();
  const parts = s.split('.');
  const whole = parts[0] || '0';
  const frac = (parts[1] || '').padEnd(18, '0').slice(0, 18);
  return BigInt(whole + frac).toString();
}

function fromWei(wei) {
  const s = BigInt(wei).toString().padStart(19, '0');
  const whole = s.slice(0, -18) || '0';
  const frac = s.slice(-18).replace(/0+$/, '');
  return frac ? `${whole}.${frac}` : whole;
}

// ═══════════════════════════════════════════════════════════════
//  RPC HELPER
// ═══════════════════════════════════════════════════════════════

async function rpc(method, params) {
  const r = await fetch(RPC, {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ jsonrpc: '2.0', id: Date.now(), method, params }),
  });
  const d = await r.json();
  if (d.error) throw new Error(d.error.message);
  return d.result;
}

async function ethCall(to, data) {
  return rpc('eth_call', [{ to, data }, 'latest']);
}

// ═══════════════════════════════════════════════════════════════
//  APP STATE
// ═══════════════════════════════════════════════════════════════

let userAddress = null;
let vaultAddress = null;
let lifetimeAccess = true;
let parsedYtId = '';
let parsedContentRef = '';
let parsedContentType = 'youtube'; // 'youtube' | 'ipfs' | 'direct'
let selectedContentType = 'video'; // 'video' | 'article' | 'file' | 'api'
let currentAddStep = 0;

// ── V2 Token State ──
let vaultVersion = 1;        // 1 or 2
let allowedTokens = [];       // [{address, symbol, decimals}] from factory
let tokenPrices = {};         // {resourceId: [{token, symbol, decimals, price}]}

// ═══════════════════════════════════════════════════════════════
//  V2 HELPERS — Version Detection & Token Reads
// ═══════════════════════════════════════════════════════════════

async function detectVaultVersion() {
  try {
    const s = selector('version()');
    const result = await ethCall(vaultAddress, '0x' + s);
    const v = Number(BigInt(result));
    if (v >= 2) { vaultVersion = v; return v; }
  } catch { /* V1 vaults don't have version() */ }
  vaultVersion = 1;
  return 1;
}

async function loadAllowedTokens() {
  if (vaultVersion < 2) return;
  try {
    const s = selector('getAllowedTokens()');
    const result = await ethCall(FACTORY, '0x' + s);
    allowedTokens = decodeAllowedTokens(result);
  } catch { allowedTokens = []; }
}

function decodeAllowedTokens(hex) {
  // Returns: (address[] tokens, string[] symbols, uint8[] decimals)
  const d = hex.slice(2);
  if (d.length < 192) return [];

  // Three dynamic arrays — get offsets
  const off0 = Number(BigInt('0x' + d.slice(0, 64))) * 2;
  const off1 = Number(BigInt('0x' + d.slice(64, 128))) * 2;
  const off2 = Number(BigInt('0x' + d.slice(128, 192))) * 2;

  // Decode addresses array
  const addrCount = Number(BigInt('0x' + d.slice(off0, off0 + 64)));
  const addresses = [];
  for (let i = 0; i < addrCount; i++) {
    addresses.push('0x' + d.slice(off0 + 64 + i * 64 + 24, off0 + 64 + (i + 1) * 64));
  }

  // Decode symbols array (array of strings)
  const symCount = Number(BigInt('0x' + d.slice(off1, off1 + 64)));
  const symbols = [];
  for (let i = 0; i < symCount; i++) {
    const strOff = Number(BigInt('0x' + d.slice(off1 + 64 + i * 64, off1 + 128 + i * 64))) * 2;
    const strLen = Number(BigInt('0x' + d.slice(off1 + strOff, off1 + strOff + 64)));
    const strHex = d.slice(off1 + strOff + 64, off1 + strOff + 64 + strLen * 2);
    symbols.push(hexToString(strHex));
  }

  // Decode decimals array
  const decCount = Number(BigInt('0x' + d.slice(off2, off2 + 64)));
  const decimals = [];
  for (let i = 0; i < decCount; i++) {
    decimals.push(Number(BigInt('0x' + d.slice(off2 + 64 + i * 64, off2 + 128 + i * 64))));
  }

  const tokens = [];
  for (let i = 0; i < addrCount; i++) {
    tokens.push({
      address: addresses[i],
      symbol: symbols[i] || 'ERC20',
      decimals: decimals[i] || 18,
    });
  }
  return tokens;
}

async function loadAcceptedTokens(resourceId) {
  if (vaultVersion < 2) return [];
  try {
    const s = selector('getAcceptedTokens(string)');
    const data = '0x' + s + padUint(32) + encodeString(resourceId);
    const result = await ethCall(vaultAddress, data);
    return decodeAcceptedTokens(result);
  } catch { return []; }
}

function decodeAcceptedTokens(hex) {
  // Returns: (address[] tokens, uint256[] prices)
  const d = hex.slice(2);
  if (d.length < 128) return [];

  const off0 = Number(BigInt('0x' + d.slice(0, 64))) * 2;
  const off1 = Number(BigInt('0x' + d.slice(64, 128))) * 2;

  const tokCount = Number(BigInt('0x' + d.slice(off0, off0 + 64)));
  const tokens = [];
  for (let i = 0; i < tokCount; i++) {
    tokens.push('0x' + d.slice(off0 + 64 + i * 64 + 24, off0 + 64 + (i + 1) * 64));
  }

  const priceCount = Number(BigInt('0x' + d.slice(off1, off1 + 64)));
  const prices = [];
  for (let i = 0; i < priceCount; i++) {
    prices.push(BigInt('0x' + d.slice(off1 + 64 + i * 64, off1 + 128 + i * 64)).toString());
  }

  return tokens.map((t, i) => {
    const allowed = allowedTokens.find(a => a.address.toLowerCase() === t.toLowerCase());
    return {
      token: t,
      symbol: allowed?.symbol || 'ERC20',
      decimals: allowed?.decimals || 18,
      price: prices[i] || '0',
    };
  });
}

function formatTokenAmount(weiStr, decimals) {
  const s = BigInt(weiStr).toString().padStart(decimals + 1, '0');
  const whole = s.slice(0, -decimals) || '0';
  const frac = s.slice(-decimals).replace(/0+$/, '');
  return frac ? `${whole}.${frac}` : whole;
}

function toTokenWei(amount, decimals) {
  const s = amount.toString();
  const parts = s.split('.');
  const whole = parts[0] || '0';
  const frac = (parts[1] || '').padEnd(decimals, '0').slice(0, decimals);
  return BigInt(whole + frac).toString();
}

// ═══════════════════════════════════════════════════════════════
//  PAGE NAVIGATION
// ═══════════════════════════════════════════════════════════════

function showPage(id) {
  if (!vaultAddress && id !== 'connect' && id !== 'create-vault') return;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const el = document.getElementById('page-' + id);
  if (el) el.classList.add('active');
  document.querySelectorAll('.sb-item').forEach(i => {
    i.classList.toggle('active', i.dataset.page === id);
  });
  if (id === 'my-content') loadMyContent();
  if (id === 'revenue') loadRevenue();
}

// ═══════════════════════════════════════════════════════════════
//  WALLET CONNECTION
// ═══════════════════════════════════════════════════════════════

async function connectWallet() {
  if (!window.ethereum) {
    setStatus('connectStatus', 'error', 'No wallet detected. Please install MetaMask.');
    return;
  }

  const btn = document.getElementById('connectBtn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Connecting...';

  try {
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    userAddress = accounts[0];

    // Switch to Apertum
    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
    if (chainId !== CHAIN_HEX) {
      try {
        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CHAIN_HEX }] });
      } catch (e) {
        if (e.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: CHAIN_HEX, chainName: 'Apertum',
              nativeCurrency: { name: 'APTM', symbol: 'APTM', decimals: 18 },
              rpcUrls: [RPC], blockExplorerUrls: [EXPLORER],
            }],
          });
        } else throw e;
      }
    }

    setStatus('connectStatus', 'info', 'Checking for existing vault...');

    const hasVaultSel = selector('hasVault(address)');
    const hasVaultData = '0x' + hasVaultSel + padAddr(userAddress);
    const hasVaultResult = await ethCall(FACTORY, hasVaultData);
    const hasVault = BigInt(hasVaultResult) === 1n;

    if (hasVault) {
      const getVaultSel = selector('getVault(address)');
      const getVaultData = '0x' + getVaultSel + padAddr(userAddress);
      const vaultResult = await ethCall(FACTORY, getVaultData);
      vaultAddress = '0x' + vaultResult.slice(-40);
      await detectVaultVersion();
      await loadAllowedTokens();
      enterDashboard();
    } else {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-create-vault').classList.add('active');
    }

  } catch (err) {
    setStatus('connectStatus', 'error', 'Connection failed: ' + (err.message || err));
    btn.disabled = false;
    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"/><circle cx="18" cy="16" r="2"/></svg> Connect Wallet';
  }
}

// ═══════════════════════════════════════════════════════════════
//  VAULT CREATION
// ═══════════════════════════════════════════════════════════════

async function createVault() {
  const btn = document.getElementById('createVaultBtn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Creating vault...';
  setStatus('vaultStatus', 'pending', 'Confirm the transaction in your wallet...');

  try {
    const createVaultSel = selector('createVault()');
    const txHash = await window.ethereum.request({
      method: 'eth_sendTransaction',
      params: [{ from: userAddress, to: FACTORY, data: '0x' + createVaultSel }],
    });

    setStatus('vaultStatus', 'pending', 'Transaction sent, waiting for confirmation...');

    // Poll for receipt
    let receipt = null;
    for (let i = 0; i < 30; i++) {
      await new Promise(r => setTimeout(r, 1500));
      receipt = await rpc('eth_getTransactionReceipt', [txHash]);
      if (receipt) break;
    }

    if (!receipt || receipt.status !== '0x1') {
      throw new Error('Transaction failed on-chain');
    }

    // Get vault address from factory
    const getVaultSel = selector('getVault(address)');
    const getVaultData = '0x' + getVaultSel + padAddr(userAddress);
    const vaultResult = await ethCall(FACTORY, getVaultData);
    vaultAddress = '0x' + vaultResult.slice(-40);

    setStatus('vaultStatus', 'success', 'Vault created! ' + vaultAddress);
    await new Promise(r => setTimeout(r, 1000));
    enterDashboard();

  } catch (err) {
    setStatus('vaultStatus', 'error', err.code === 4001 ? 'Transaction rejected.' : 'Failed: ' + err.message);
    btn.disabled = false;
    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg> Create Vault (~0.002 APTM)';
  }
}

function enterDashboard() {
  // Update sidebar
  document.getElementById('sidebarWallet').classList.add('show');
  document.getElementById('sidebarAddr').textContent = userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
  document.getElementById('sidebarVault').textContent = 'Vault: ' + vaultAddress.slice(0, 8) + '...' + vaultAddress.slice(-6);
  document.getElementById('vaultLink').textContent = vaultAddress;
  document.getElementById('vaultLink').href = EXPLORER + '/address/' + vaultAddress;
  document.getElementById('explorerLink').href = EXPLORER + '/address/' + vaultAddress;

  // Detect V2 and load tokens in background
  detectVaultVersion().then(v => {
    if (v >= 2) {
      loadAllowedTokens().then(() => renderTokenPricingUI());
    }
  });

  showPage('add-content');
}

// ═══════════════════════════════════════════════════════════════
//  ADD CONTENT WIZARD
// ═══════════════════════════════════════════════════════════════

function detectContentSource(input) {
  if (!input) return { type: 'unknown', value: '' };
  const trimmed = input.trim();
  if (trimmed.startsWith('ipfs://')) return { type: 'ipfs', value: trimmed };
  if (trimmed.includes('/ipfs/') || trimmed.includes('/ipns/')) return { type: 'ipfs', value: trimmed };
  const videoExts = /\.(mp4|webm|ogg|mov|m3u8|mkv)(\?.*)?$/i;
  if ((trimmed.startsWith('http://') || trimmed.startsWith('https://')) && videoExts.test(trimmed))
    return { type: 'direct', value: trimmed };
  const ytPatterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/)([a-zA-Z0-9_-]{11})/,
  ];
  for (const p of ytPatterns) { const m = trimmed.match(p); if (m) return { type: 'youtube', value: m[1] }; }
  if (trimmed.startsWith('http://') || trimmed.startsWith('https://')) return { type: 'direct', value: trimmed };
  if (/^(Qm[a-zA-Z0-9]{44,}|bafy[a-zA-Z0-9]{50,})$/.test(trimmed)) return { type: 'ipfs', value: 'ipfs://' + trimmed };
  if (/^[a-zA-Z0-9_-]{11}$/.test(trimmed)) return { type: 'youtube', value: trimmed };
  return { type: 'unknown', value: trimmed };
}

function selectContentType(type) {
  selectedContentType = type;
  // Update selector UI
  document.querySelectorAll('#typeSelector .type-option').forEach(el => {
    el.classList.toggle('selected', el.dataset.type === type);
  });
  // Show/hide field panels
  document.getElementById('fieldsVideo').style.display = type === 'video' ? 'block' : 'none';
  document.getElementById('fieldsArticle').style.display = type === 'article' ? 'block' : 'none';
  document.getElementById('fieldsFile').style.display = type === 'file' ? 'block' : 'none';
  document.getElementById('fieldsApi').style.display = type === 'api' ? 'block' : 'none';
  // Clear parsed state and re-parse current input
  parsedYtId = ''; parsedContentRef = ''; parsedContentType = 'unknown';
  parseContentInput();
}

function parseContentInput() {
  const resInput = document.getElementById('resId');

  if (selectedContentType === 'video') {
    // Video parsing — same as before
    const input = document.getElementById('ytInput').value.trim();
    const preview = document.getElementById('thumbPreview');

    if (!input) {
      parsedYtId = ''; parsedContentRef = ''; parsedContentType = 'unknown';
      preview.innerHTML = '<div class="placeholder">Video preview will appear here</div>';
      return;
    }

    const source = detectContentSource(input);
    parsedContentType = source.type;

    if (source.type === 'youtube') {
      parsedYtId = source.value;
      parsedContentRef = source.value;
      preview.innerHTML = `<img src="https://img.youtube.com/vi/${source.value}/hqdefault.jpg" alt="Video thumbnail">`;
      if (!resInput.value) resInput.value = 'video-' + source.value.slice(0, 6).toLowerCase();
    } else if (source.type === 'ipfs') {
      parsedYtId = ''; parsedContentRef = source.value;
      const displayCid = source.value.replace('ipfs://', '').slice(0, 24) + '...';
      preview.innerHTML = `
        <div style="display:flex;align-items:center;gap:14px;padding:20px;background:linear-gradient(135deg,#0a0b0d,#141620);border-radius:10px;min-height:80px;">
          <svg viewBox="0 0 24 24" style="width:40px;height:40px;stroke:var(--blue-light);fill:none;stroke-width:1.5;flex-shrink:0;">
            <polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/>
          </svg>
          <div style="display:flex;flex-direction:column;gap:2px;">
            <span style="font-size:12px;color:var(--text-bright);font-weight:500;">IPFS Video</span>
            <span style="font-size:11px;color:var(--text-dim);font-family:var(--mono);">${displayCid}</span>
          </div>
        </div>`;
      const cidPart = source.value.replace('ipfs://', '').replace(/^https?:\/\/.*\/ipfs\//, '').slice(0, 8).toLowerCase();
      if (!resInput.value) resInput.value = 'video-' + cidPart;
    } else if (source.type === 'direct') {
      parsedYtId = ''; parsedContentRef = source.value;
      let urlHost = source.value;
      try { urlHost = new URL(source.value).hostname; } catch {}
      preview.innerHTML = `
        <div style="display:flex;align-items:center;gap:14px;padding:20px;background:linear-gradient(135deg,#0a0b0d,#141620);border-radius:10px;min-height:80px;">
          <svg viewBox="0 0 24 24" style="width:40px;height:40px;stroke:var(--green);fill:none;stroke-width:1.5;flex-shrink:0;">
            <polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/>
          </svg>
          <div style="display:flex;flex-direction:column;gap:2px;">
            <span style="font-size:12px;color:var(--text-bright);font-weight:500;">Direct Video URL</span>
            <span style="font-size:11px;color:var(--text-dim);font-family:var(--mono);">${urlHost}</span>
          </div>
        </div>`;
      const slug = urlHost.replace(/\./g, '-').slice(0, 8);
      if (!resInput.value) resInput.value = 'video-' + slug;
    } else {
      parsedYtId = ''; parsedContentRef = '';
      preview.innerHTML = '<div class="placeholder">Could not detect video source. Try a YouTube URL, IPFS URL, or direct .mp4 link.</div>';
    }

  } else if (selectedContentType === 'article') {
    const input = document.getElementById('articleInput').value.trim();
    const preview = document.getElementById('articlePreview');
    if (!input) {
      parsedContentRef = '';
      preview.innerHTML = '<div class="placeholder" style="display:flex;flex-direction:column;align-items:center;gap:8px;"><svg viewBox="0 0 24 24" style="width:36px;height:36px;stroke:var(--violet);fill:none;stroke-width:1.5;opacity:0.5;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Article source preview</div>';
      return;
    }
    parsedContentRef = input;
    parsedContentType = input.startsWith('ipfs://') || input.includes('/ipfs/') ? 'ipfs' : 'direct';
    const shortRef = input.length > 40 ? input.slice(0, 37) + '...' : input;
    preview.innerHTML = `
      <div style="display:flex;align-items:center;gap:14px;padding:20px;background:linear-gradient(135deg,#0a0b0d,#14121e);border-radius:10px;min-height:80px;">
        <svg viewBox="0 0 24 24" style="width:40px;height:40px;stroke:var(--violet);fill:none;stroke-width:1.5;flex-shrink:0;">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>
        </svg>
        <div style="display:flex;flex-direction:column;gap:2px;">
          <span style="font-size:12px;color:var(--text-bright);font-weight:500;">Article / Text Content</span>
          <span style="font-size:11px;color:var(--text-dim);font-family:var(--mono);">${shortRef}</span>
        </div>
      </div>`;
    if (!resInput.value) {
      const slug = input.replace(/^(ipfs:\/\/|https?:\/\/)/, '').slice(0, 10).replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
      resInput.value = 'article-' + slug;
    }

  } else if (selectedContentType === 'file') {
    const input = document.getElementById('fileInput').value.trim();
    if (!input) { parsedContentRef = ''; return; }
    parsedContentRef = input;
    parsedContentType = input.startsWith('ipfs://') || input.includes('/ipfs/') ? 'ipfs' : 'direct';
    if (!resInput.value) {
      const slug = input.replace(/^(ipfs:\/\/|https?:\/\/)/, '').slice(0, 10).replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
      resInput.value = 'file-' + slug;
    }

  } else if (selectedContentType === 'api') {
    const input = document.getElementById('apiInput').value.trim();
    if (!input) { parsedContentRef = ''; return; }
    parsedContentRef = input;
    parsedContentType = 'direct';
    if (!resInput.value) {
      let host = input;
      try { host = new URL(input).hostname; } catch {}
      resInput.value = 'api-' + host.replace(/\./g, '-').slice(0, 12);
    }
  }
}

// Keep backward compat alias
function parseYouTube() { parseContentInput(); }

function toggleLifetime() {
  lifetimeAccess = !lifetimeAccess;
  document.getElementById('lifetimeToggle').classList.toggle('on', lifetimeAccess);
}

function addStep(step) {
  // Validate
  if (step > 0 && !parsedContentRef) {
    const msgs = { video: 'a valid YouTube URL, IPFS URL, or video URL', article: 'an article URL or IPFS hash', file: 'a file URL or IPFS hash', api: 'an API endpoint URL' };
    alert('Please enter ' + (msgs[selectedContentType] || 'content source') + '.'); return;
  }
  if (step > 0 && !document.getElementById('resId').value.trim()) { alert('Resource ID is required.'); return; }
  if (step > 1) {
    const price = parseFloat(document.getElementById('priceInput').value);
    if (!price || price <= 0) { alert('Price must be greater than 0.'); return; }
  }

  currentAddStep = step;

  // Show/hide steps
  for (let i = 0; i <= 2; i++) {
    document.getElementById('addStep' + i).style.display = i === step ? 'block' : 'none';
  }

  // Update wizard bar
  for (let i = 0; i <= 2; i++) {
    const seg = document.getElementById('wiz' + i);
    seg.className = 'wiz-seg';
    if (i < step) seg.classList.add('done');
    if (i === step) seg.classList.add('current');
  }

  // Populate review step
  if (step === 2) {
    // Type-aware thumbnail in review
    const typeIcons = {
      video: { icon: '<polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/>', color: 'var(--blue-light)', label: '' },
      article: { icon: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>', color: 'var(--violet)', label: 'Article' },
      file: { icon: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>', color: 'var(--amber)', label: 'File Download' },
      api: { icon: '<polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>', color: '#06b6d4', label: 'API Access' },
    };

    if (selectedContentType === 'video' && parsedContentType === 'youtube') {
      document.getElementById('reviewThumb').innerHTML = `<img src="https://img.youtube.com/vi/${parsedContentRef}/hqdefault.jpg" alt="">`;
    } else {
      const t = typeIcons[selectedContentType] || typeIcons.video;
      const label = t.label || (parsedContentType === 'ipfs' ? 'IPFS Video' : 'Direct Video');
      document.getElementById('reviewThumb').innerHTML = `
        <div style="display:flex;align-items:center;justify-content:center;height:100%;background:#0a0b0d;border-radius:10px;padding:16px;">
          <div style="text-align:center;">
            <svg viewBox="0 0 24 24" style="width:32px;height:32px;stroke:${t.color};fill:none;stroke-width:1.5;margin-bottom:8px;">${t.icon}</svg>
            <div style="font-size:11px;color:var(--text-dim);font-family:var(--mono);">${label}</div>
          </div>
        </div>`;
    }
    document.getElementById('reviewResId').textContent = document.getElementById('resId').value;
    document.getElementById('reviewType').textContent = selectedContentType.charAt(0).toUpperCase() + selectedContentType.slice(1);
    document.getElementById('reviewPrice').textContent = document.getElementById('priceInput').value + ' APTM';
    document.getElementById('reviewAccess').textContent = lifetimeAccess ? 'Lifetime' : 'Per-access';
    document.getElementById('reviewYtId').textContent = parsedContentRef.length > 40 ? parsedContentRef.slice(0, 37) + '...' : parsedContentRef;
    document.getElementById('embedOutput').style.display = 'none';
    document.getElementById('reviewGas').textContent = 'Estimating...';

    // Show token prices in review if V2
    const tokenPriceList = getTokenPriceInputs();
    const reviewTokCard = document.getElementById('reviewTokenPricesCard');
    if (vaultVersion >= 2 && tokenPriceList.length > 0) {
      reviewTokCard.style.display = 'block';
      document.getElementById('reviewTokenPrices').innerHTML = tokenPriceList
        .map(tp => `${tp.price} <span class="unit" style="font-size:11px;color:#8b5cf6;margin-left:3px;">${tp.symbol}</span>`)
        .join(' &nbsp;·&nbsp; ');
    } else {
      reviewTokCard.style.display = 'none';
    }

    // Reset publish button in case they came back after a publish
    const pubBtn = document.getElementById('publishBtn');
    pubBtn.disabled = false;
    pubBtn.innerHTML = '<svg viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg> Publish On-Chain';
    document.getElementById('publishStatus').className = 'status-bar';

    // Estimate gas in the background
    estimatePublishGas();
  }

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ═══════════════════════════════════════════════════════════════
//  GAS ESTIMATION
// ═══════════════════════════════════════════════════════════════

// ── V2 Token Pricing UI Renderer ──
function renderTokenPricingUI() {
  const section = document.getElementById('tokenPricingSection');
  if (vaultVersion < 2 || allowedTokens.length === 0) {
    section.style.display = 'none';
    return;
  }
  section.style.display = 'block';

  const container = document.getElementById('tokenPriceInputs');
  let html = '';
  for (const tok of allowedTokens) {
    html += `
      <div class="field" style="margin-bottom:10px;">
        <label>${tok.symbol} Price <span class="hint">Optional — leave blank or 0 to not accept ${tok.symbol}</span></label>
        <div class="input-with-tag">
          <input type="number" id="tokenPrice-${tok.address}" placeholder="0" min="0" step="any" data-token="${tok.address}" data-symbol="${tok.symbol}" data-decimals="${tok.decimals}">
          <div class="input-tag" style="color:#8b5cf6;">${tok.symbol}</div>
        </div>
      </div>`;
  }
  container.innerHTML = html;
}

function getTokenPriceInputs() {
  const inputs = document.querySelectorAll('#tokenPriceInputs input[data-token]');
  const prices = [];
  for (const inp of inputs) {
    const val = parseFloat(inp.value);
    if (val && val > 0) {
      prices.push({
        token: inp.dataset.token,
        symbol: inp.dataset.symbol,
        decimals: parseInt(inp.dataset.decimals),
        price: val,
      });
    }
  }
  return prices;
}

async function setTokenPricesOnChain(resourceId, tokenPriceList) {
  // Call setTokenPrice(string,address,uint256) for each token
  for (const tp of tokenPriceList) {
    const s = selector('setTokenPrice(string,address,uint256)');
    const priceWei = toTokenWei(tp.price, tp.decimals);
    // ABI: offset-to-string, address, uint256, then string data
    const resIdEncoded = encodeString(resourceId);
    const headSize = 3 * 32; // 3 head slots: string-offset, address, uint256
    const data = '0x' + s +
      padUint(headSize) +                          // offset to resourceId
      padAddr(tp.token) +                          // token address
      padUint(priceWei) +                          // price in token units
      resIdEncoded;

    const txHash = await window.ethereum.request({
      method: 'eth_sendTransaction',
      params: [{ from: userAddress, to: vaultAddress, data }],
    });

    // Wait for confirmation
    for (let i = 0; i < 25; i++) {
      await new Promise(r => setTimeout(r, 1500));
      const receipt = await rpc('eth_getTransactionReceipt', [txHash]);
      if (receipt) {
        if (receipt.status !== '0x1') throw new Error(`setTokenPrice(${tp.symbol}) reverted`);
        break;
      }
    }
  }
}

async function estimatePublishGas() {
  const gasEl = document.getElementById('reviewGas');
  try {
    const resourceId = document.getElementById('resId').value.trim();
    const price = toWei(document.getElementById('priceInput').value);
    const contentType = selectedContentType;
    const contentRef = parsedContentRef;

    // Build the same calldata as publishResource
    const sel = selector('addResource(string,uint256,bool,string,string)');

    function encodeStrAt(s) {
      const bytes = new TextEncoder().encode(s);
      const lenHex = padUint(bytes.length);
      let dataHex = '';
      for (const b of bytes) dataHex += b.toString(16).padStart(2, '0');
      return lenHex + dataHex.padEnd(Math.ceil(dataHex.length / 64) * 64, '0');
    }

    const headSize = 5 * 32;
    const resIdEncoded = encodeStrAt(resourceId);
    const resIdSize = resIdEncoded.length / 2;
    const typeEncoded = encodeStrAt(contentType);
    const typeSize = typeEncoded.length / 2;
    const refEncoded = encodeStrAt(contentRef);

    const offset0 = headSize;
    const offset3 = offset0 + resIdSize;
    const offset4 = offset3 + typeSize;

    const data = '0x' + sel +
      padUint(offset0) + padUint(price) + padBool(lifetimeAccess) +
      padUint(offset3) + padUint(offset4) +
      resIdEncoded + typeEncoded + refEncoded;

    // Call eth_estimateGas and eth_gasPrice in parallel
    const [gasEstimate, gasPrice] = await Promise.all([
      rpc('eth_estimateGas', [{ from: userAddress, to: vaultAddress, data }]),
      rpc('eth_gasPrice', []),
    ]);

    const gasUnits = BigInt(gasEstimate);
    const gasPriceWei = BigInt(gasPrice);
    const totalWei = gasUnits * gasPriceWei;
    const totalAptm = fromWei(totalWei.toString());

    gasEl.innerHTML = `~${totalAptm}<span class="unit" style="font-size:11px;color:var(--blue-light);margin-left:3px;">APTM</span> <span style="font-size:11px;color:var(--text-dim);">(${gasUnits.toLocaleString()} gas)</span>`;

  } catch (err) {
    // If estimation fails (e.g. resource already exists), show a fallback
    gasEl.innerHTML = `~0.003<span class="unit" style="font-size:11px;color:var(--blue-light);margin-left:3px;">APTM</span> <span style="font-size:11px;color:var(--text-dim);">(est.)</span>`;
  }
}

// ═══════════════════════════════════════════════════════════════
//  PUBLISH RESOURCE (on-chain)
// ═══════════════════════════════════════════════════════════════

async function publishResource() {
  const btn = document.getElementById('publishBtn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Publishing...';
  setStatus('publishStatus', 'pending', 'Confirm the transaction in your wallet...');

  const resourceId = document.getElementById('resId').value.trim();
  const price = toWei(document.getElementById('priceInput').value);
  const contentType = selectedContentType;
  const contentRef = parsedContentRef;

  try {
    // Encode addResource(string, uint256, bool, string, string)
    const sel = selector('addResource(string,uint256,bool,string,string)');

    // ABI encode with dynamic types
    // Head: 5 slots (offsets for strings + static values)
    // Slot 0: offset to resourceId string
    // Slot 1: uint256 price
    // Slot 2: bool lifetimeAccess
    // Slot 3: offset to contentType string
    // Slot 4: offset to contentRef string

    const resIdBytes = new TextEncoder().encode(resourceId);
    const typeBytes = new TextEncoder().encode(contentType);
    const refBytes = new TextEncoder().encode(contentRef);

    function encodeStrAt(s) {
      const bytes = new TextEncoder().encode(s);
      const lenHex = padUint(bytes.length);
      let dataHex = '';
      for (const b of bytes) dataHex += b.toString(16).padStart(2, '0');
      return lenHex + dataHex.padEnd(Math.ceil(dataHex.length / 64) * 64, '0');
    }

    // Calculate offsets (in bytes from start of params)
    // 5 head slots = 5 * 32 = 160 bytes offset for first string
    const headSize = 5 * 32;
    const resIdEncoded = encodeStrAt(resourceId);
    const resIdSize = resIdEncoded.length / 2; // bytes
    const typeEncoded = encodeStrAt(contentType);
    const typeSize = typeEncoded.length / 2;
    const refEncoded = encodeStrAt(contentRef);

    const offset0 = headSize; // resourceId offset
    const offset3 = offset0 + resIdSize; // contentType offset
    const offset4 = offset3 + typeSize; // contentRef offset

    const data = '0x' + sel +
      padUint(offset0) +         // offset to resourceId
      padUint(price) +           // price (static)
      padBool(lifetimeAccess) +  // lifetime (static)
      padUint(offset3) +         // offset to contentType
      padUint(offset4) +         // offset to contentRef
      resIdEncoded +
      typeEncoded +
      refEncoded;

    const txHash = await window.ethereum.request({
      method: 'eth_sendTransaction',
      params: [{ from: userAddress, to: vaultAddress, data }],
    });

    setStatus('publishStatus', 'pending', 'Transaction sent! Waiting for confirmation...');

    // Poll for receipt
    let receipt = null;
    for (let i = 0; i < 30; i++) {
      await new Promise(r => setTimeout(r, 1500));
      receipt = await rpc('eth_getTransactionReceipt', [txHash]);
      if (receipt) break;
    }

    if (!receipt || receipt.status !== '0x1') throw new Error('Transaction reverted on-chain');

    setStatus('publishStatus', 'success',
      '✓ Published! <a href="' + EXPLORER + '/tx/' + txHash + '" target="_blank">View transaction</a>');

    // V2: Set token prices if any were configured
    const tokenPriceList = getTokenPriceInputs();
    if (vaultVersion >= 2 && tokenPriceList.length > 0) {
      setStatus('publishStatus', 'pending',
        '✓ Resource published! Now setting token prices (' + tokenPriceList.length + ')... Confirm each in wallet.');
      try {
        await setTokenPricesOnChain(resourceId, tokenPriceList);
        setStatus('publishStatus', 'success',
          '✓ Published with token pricing! <a href="' + EXPLORER + '/tx/' + txHash + '" target="_blank">View transaction</a>');
      } catch (tokErr) {
        setStatus('publishStatus', 'success',
          '✓ Resource published, but token pricing failed: ' + tokErr.message + '. You can set token prices from My Content → Edit.');
      }
    }

    // Show embed codes
    const embedEl = document.getElementById('embedOutput');
    embedEl.style.display = 'block';

    const hostedUrl = `${window.location.origin}/watch.html?vault=${vaultAddress}&resource=${resourceId}`;
    document.getElementById('embedLink').textContent = hostedUrl;

    document.getElementById('embedIframe').textContent =
      `<iframe src="${hostedUrl}"\n  width="640" height="400" frameborder="0"\n  allow="ethereum *">\n</iframe>`;

    document.getElementById('embedScript').textContent =
      `<div class="a402-content"\n  data-vault="${vaultAddress}"\n  data-resource="${resourceId}">\n</div>\n<script src="https://cdn.a402.io/embed.js"><\/script>`;

    btn.innerHTML = '<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg> Published!';

    // Update content count badge
    loadContentCount();

  } catch (err) {
    setStatus('publishStatus', 'error', err.code === 4001 ? 'Transaction rejected.' : 'Failed: ' + err.message);
    btn.disabled = false;
    btn.innerHTML = '<svg viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg> Publish On-Chain';
  }
}

// ═══════════════════════════════════════════════════════════════
//  MY CONTENT (read from chain)
// ═══════════════════════════════════════════════════════════════

async function loadContentCount() {
  try {
    const sel = selector('resourceCount()');
    const result = await ethCall(vaultAddress, '0x' + sel);
    const count = Number(BigInt(result));
    document.getElementById('contentCount').textContent = count;
  } catch { /* ignore */ }
}

async function loadMyContent() {
  const container = document.getElementById('contentList');
  container.innerHTML = '<div style="font-family:var(--mono);font-size:12px;color:var(--text-dim);">Loading from chain...</div>';

  try {
    const countSel = selector('resourceCount()');
    const countResult = await ethCall(vaultAddress, '0x' + countSel);
    const count = Number(BigInt(countResult));

    document.getElementById('contentCount').textContent = count;

    if (count === 0) {
      container.innerHTML = '<div class="empty-state"><p>No content yet. Go to "Add Content" to publish your first resource.</p></div>';
      return;
    }

    const items = [];
    for (let i = 0; i < count; i++) {
      const resSel = selector('getResourceByIndex(uint256)');
      const data = '0x' + resSel + padUint(i);
      const result = await ethCall(vaultAddress, data);
      items.push(decodeResourceByIndex(result));
    }

    let html = '<div class="res-list">';
    for (const item of items) {
      const priceAptm = fromWei(item.price);
      const accessLabel = item.lifetime ? 'Lifetime' : 'Per-access';
      const accessClass = item.lifetime ? 'lifetime' : 'per-access';
      const statusLabel = item.active ? 'Active' : 'Paused';
      const statusClass = item.active ? 'active' : 'paused';
      const rev = fromWei(item.revenue);
      const safeId = item.resourceId.replace(/'/g, "\\'");
      const typeBadgeClass = ['video','article','file','api'].includes(item.contentType) ? item.contentType : 'video';
      const typeIconSvg = {
        video: '<polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/>',
        article: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>',
        file: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>',
        api: '<polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>',
      }[typeBadgeClass] || '';

      html += `
        <div class="res-item" id="res-${item.resourceId}" style="display:block;">
          <div style="display:grid; grid-template-columns:1fr auto; gap:16px; align-items:center;">
            <div class="res-meta">
              <div class="res-title-row">
                <span class="res-id">${item.resourceId}</span>
                <span class="res-badge ${typeBadgeClass}"><svg viewBox="0 0 24 24" style="width:10px;height:10px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;vertical-align:-1px;margin-right:3px;">${typeIconSvg}</svg>${item.contentType}</span>
                <span class="res-badge ${accessClass}">${accessLabel}</span>
                <span class="res-badge ${statusClass}">${statusLabel}</span>
              </div>
              <div class="res-stats">
                <span>Price: ${priceAptm} APTM</span>
                <span>Payments: ${item.payments}</span>
                <span>Revenue: ${rev} APTM</span>
              </div>
              <div class="res-stats token-prices-row" id="tokenPrices-${item.resourceId}" style="margin-top:2px;"></div>
            </div>
            <div class="res-actions">
              <button class="btn btn-sm btn-secondary" onclick="openEdit('${safeId}', ${item.price}, ${item.lifetime})">
                <svg viewBox="0 0 24 24" style="width:12px;height:12px;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                Edit
              </button>
              <div class="embed-wrap">
                <button class="btn btn-sm btn-secondary" onclick="toggleEmbedDropdown('${safeId}', event)">
                  <svg viewBox="0 0 24 24" style="width:12px;height:12px;"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                  Embed
                  <svg viewBox="0 0 24 24" style="width:10px;height:10px;margin-left:-2px;"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="embed-dropdown" id="embedDrop-${item.resourceId}">
                  <div class="ed-title">Embed & Integration</div>
                  <div class="ed-row">
                    <span class="ed-label">Hosted Link <small>— viewer page URL</small></span>
                    <button class="ed-copy" onclick="copyEmbedFormat('${safeId}','link',this,event)">Copy</button>
                  </div>
                  <div class="ed-row">
                    <span class="ed-label">iframe <small>— drop into any HTML</small></span>
                    <button class="ed-copy" onclick="copyEmbedFormat('${safeId}','iframe',this,event)">Copy</button>
                  </div>
                  <div class="ed-row">
                    <span class="ed-label">Script Tag <small>— auto-rendering widget</small></span>
                    <button class="ed-copy" onclick="copyEmbedFormat('${safeId}','script',this,event)">Copy</button>
                  </div>
                  <div class="ed-preview" id="embedPreview-${item.resourceId}"></div>
                </div>
              </div>
              ${item.active
                ? `<button class="btn btn-sm btn-red" onclick="togglePause('${safeId}', true)">Pause</button>`
                : `<button class="btn btn-sm btn-green" onclick="togglePause('${safeId}', false)">Unpause</button>`
              }
            </div>
          </div>
          <div class="res-edit" id="edit-${item.resourceId}">
            <div class="edit-grid">
              <div>
                <label>Price (APTM)</label>
                <input type="number" id="editPrice-${item.resourceId}" value="${priceAptm}" min="0.0001" step="0.0001">
              </div>
              <div>
                <label>Lifetime Access</label>
                <div class="edit-toggle ${item.lifetime ? 'on' : ''}" id="editLifetime-${item.resourceId}" onclick="toggleEditLifetime('${safeId}')">
                  <span>${item.lifetime ? 'Lifetime' : 'Per-access'}</span>
                  <div class="mini-track"></div>
                </div>
              </div>
              <div class="edit-full">
                <label>Content Ref (YouTube ID / URL / IPFS hash)</label>
                <input type="text" id="editRef-${item.resourceId}" placeholder="Loading..." disabled>
              </div>
              <div class="edit-full" id="editTokenSection-${item.resourceId}" style="display:none;">
                <label style="display:flex;align-items:center;gap:6px;">
                  Token Prices
                  <span style="font-family:var(--mono);font-size:8px;padding:1px 5px;border-radius:3px;background:rgba(139,92,246,0.08);color:#8b5cf6;border:1px solid rgba(139,92,246,0.1);">V2</span>
                </label>
                <div id="editTokenInputs-${item.resourceId}"></div>
              </div>
            </div>
            <div class="edit-actions">
              <button class="btn btn-sm btn-primary" onclick="saveEdit('${safeId}')" id="editSaveBtn-${item.resourceId}">Save Changes</button>
              <button class="btn btn-sm btn-secondary" onclick="closeEdit('${safeId}')">Cancel</button>
            </div>
            <div class="edit-status" id="editStatus-${item.resourceId}"></div>
          </div>
        </div>`;
    }
    html += '</div>';
    container.innerHTML = html;

    // V2: Load token prices for each resource in background
    if (vaultVersion >= 2) {
      for (const item of items) {
        loadTokenPricesForResource(item.resourceId);
      }
    }

  } catch (err) {
    container.innerHTML = `<div class="status-bar show error">Failed to load: ${err.message}</div>`;
  }
}

function decodeResourceByIndex(hex) {
  // Returns: (string resourceId, uint256 price, bool lifetime, bool active, string contentType, uint256 revenue, uint256 payments)
  const d = hex.slice(2);
  // Parse ABI-encoded response with dynamic strings
  // Word 0: offset to resourceId string
  // Word 1: price (uint256)
  // Word 2: lifetimeAccess (bool)
  // Word 3: active (bool)
  // Word 4: offset to contentType string
  // Word 5: revenue (uint256)
  // Word 6: payments (uint256)
  const price = BigInt('0x' + d.slice(64, 128)).toString();
  const lifetime = BigInt('0x' + d.slice(128, 192)) === 1n;
  const active = BigInt('0x' + d.slice(192, 256)) === 1n;
  const revenue = BigInt('0x' + d.slice(320, 384)).toString();
  const payments = Number(BigInt('0x' + d.slice(384, 448)));

  // Decode resourceId string (offset at word 0)
  const resIdOffset = Number(BigInt('0x' + d.slice(0, 64))) * 2;
  const resIdLen = Number(BigInt('0x' + d.slice(resIdOffset, resIdOffset + 64)));
  const resIdHex = d.slice(resIdOffset + 64, resIdOffset + 64 + resIdLen * 2);
  const resourceId = hexToString(resIdHex);

  // Decode contentType string (offset at word 4)
  const typeOffset = Number(BigInt('0x' + d.slice(256, 320))) * 2;
  const typeLen = Number(BigInt('0x' + d.slice(typeOffset, typeOffset + 64)));
  const typeHex = d.slice(typeOffset + 64, typeOffset + 64 + typeLen * 2);
  const contentType = hexToString(typeHex);

  return { resourceId, price, lifetime, active, contentType, revenue, payments };
}

function hexToString(hex) {
  let s = '';
  for (let i = 0; i < hex.length; i += 2) {
    s += String.fromCharCode(parseInt(hex.slice(i, i + 2), 16));
  }
  return s;
}

// ═══════════════════════════════════════════════════════════════
//  V2 TOKEN PRICES — Per-Resource Display & Edit
// ═══════════════════════════════════════════════════════════════

async function loadTokenPricesForResource(resourceId) {
  try {
    const accepted = await loadAcceptedTokens(resourceId);
    const row = document.getElementById('tokenPrices-' + resourceId);
    if (row && accepted.length > 0) {
      row.innerHTML = accepted
        .map(t => `<span style="color:#8b5cf6;">${formatTokenAmount(t.price, t.decimals)} ${t.symbol}</span>`)
        .join('');
    }

    // Also populate edit inputs if section exists
    const editSection = document.getElementById('editTokenSection-' + resourceId);
    const editInputs = document.getElementById('editTokenInputs-' + resourceId);
    if (editSection && allowedTokens.length > 0) {
      editSection.style.display = 'block';
      let html = '';
      for (const tok of allowedTokens) {
        const existing = accepted.find(a => a.token.toLowerCase() === tok.address.toLowerCase());
        const currentVal = existing ? formatTokenAmount(existing.price, tok.decimals) : '';
        html += `
          <div style="display:grid;grid-template-columns:1fr auto;gap:0;margin-bottom:6px;">
            <input type="number" id="editTokPrice-${resourceId}-${tok.address}"
              value="${currentVal}" placeholder="0" min="0" step="any"
              data-token="${tok.address}" data-symbol="${tok.symbol}" data-decimals="${tok.decimals}"
              style="width:100%;padding:8px 11px;background:var(--bg-input);border:1px solid var(--border);border-radius:6px 0 0 6px;color:var(--text-bright);font-family:var(--mono);font-size:12px;outline:none;">
            <div style="padding:8px 12px;background:var(--bg-input);border:1px solid var(--border);border-left:none;border-radius:0 6px 6px 0;font-family:var(--mono);font-size:11px;color:#8b5cf6;font-weight:500;display:flex;align-items:center;">${tok.symbol}</div>
          </div>`;
      }
      editInputs.innerHTML = html;
    }

    // Store for reference
    tokenPrices[resourceId] = accepted;
  } catch { /* silent */ }
}

async function saveTokenPriceEdits(resourceId) {
  const inputs = document.querySelectorAll(`#editTokenInputs-${resourceId} input[data-token]`);
  const toSet = [];
  for (const inp of inputs) {
    const val = parseFloat(inp.value);
    const existing = (tokenPrices[resourceId] || []).find(t => t.token.toLowerCase() === inp.dataset.token.toLowerCase());
    const existingVal = existing ? formatTokenAmount(existing.price, parseInt(inp.dataset.decimals)) : '0';
    const newVal = val > 0 ? val.toString() : '0';
    if (newVal !== existingVal) {
      toSet.push({
        token: inp.dataset.token,
        symbol: inp.dataset.symbol,
        decimals: parseInt(inp.dataset.decimals),
        price: val || 0,
      });
    }
  }
  if (toSet.length > 0) {
    await setTokenPricesOnChain(resourceId, toSet);
  }
}

// ═══════════════════════════════════════════════════════════════
//  REVENUE
// ═══════════════════════════════════════════════════════════════

async function loadRevenue() {
  try {
    // getVaultStats() → (balance, totalRevenue, totalWithdrawn, resourceCount)
    const sel = selector('getVaultStats()');
    const result = await ethCall(vaultAddress, '0x' + sel);
    const d = result.slice(2);

    const balance = BigInt('0x' + d.slice(0, 64)).toString();
    const totalRev = BigInt('0x' + d.slice(64, 128)).toString();
    const totalWith = BigInt('0x' + d.slice(128, 192)).toString();
    const resCount = Number(BigInt('0x' + d.slice(192, 256)));

    document.getElementById('statBalance').innerHTML = fromWei(balance) + '<span class="unit">APTM</span>';
    document.getElementById('statRevenue').innerHTML = fromWei(totalRev) + '<span class="unit">APTM</span>';
    document.getElementById('statWithdrawn').innerHTML = fromWei(totalWith) + '<span class="unit">APTM</span>';
    document.getElementById('statResources').textContent = resCount;

    document.getElementById('withdrawBtn').disabled = BigInt(balance) === 0n;

    // Load per-resource breakdown
    const breakdown = document.getElementById('revenueBreakdown');
    if (resCount === 0) {
      breakdown.innerHTML = '<div style="font-family:var(--mono);font-size:12px;color:var(--text-dim);">No resources yet.</div>';
      loadPaymentEvents();
      return;
    }

    let html = '<div class="res-list">';
    for (let i = 0; i < resCount; i++) {
      const resSel = selector('getResourceByIndex(uint256)');
      const data = '0x' + resSel + padUint(i);
      const res = await ethCall(vaultAddress, data);
      const item = decodeResourceByIndex(res);

      html += `
        <div class="res-item" style="grid-template-columns: 1fr auto auto;">
          <div class="res-meta">
            <div class="res-title-row">
              <span class="res-id">${item.resourceId}</span>
              <span class="res-badge video">${item.contentType}</span>
            </div>
          </div>
          <div style="text-align:right;">
            <div style="font-family:var(--mono);font-size:14px;font-weight:600;color:var(--text-bright);">${fromWei(item.revenue)} APTM</div>
            <div style="font-family:var(--mono);font-size:10px;color:var(--text-dim);">revenue</div>
          </div>
          <div style="text-align:right;">
            <div style="font-family:var(--mono);font-size:14px;font-weight:600;color:var(--text-bright);">${item.payments}</div>
            <div style="font-family:var(--mono);font-size:10px;color:var(--text-dim);">payments</div>
          </div>
        </div>`;
    }
    html += '</div>';
    breakdown.innerHTML = html;

    // Load event logs for chart + transaction table
    loadPaymentEvents();

  } catch (err) {
    document.getElementById('revenueBreakdown').innerHTML = `<div class="status-bar show error">${err.message}</div>`;
  }
}

// ═══════════════════════════════════════════════════════════════
//  REVENUE DASHBOARD — Event Logs, Chart, Transactions
// ═══════════════════════════════════════════════════════════════

let allPaymentEvents = [];
let chartRange = 7; // days, 0 = all
let txPage = 0;
const TX_PER_PAGE = 10;

async function loadPaymentEvents() {
  const emptyEl = document.getElementById('chartEmpty');
  const tableWrap = document.getElementById('txTableWrap');
  try {
    // The CreatorVault may emit events with different signatures than the A402Verifier.
    // Strategy: fetch ALL logs from the vault, then try to match known event patterns.
    // We try multiple candidate topic0 hashes for AccessPaid variants.

    const candidates = [
      // CreatorVault: AccessPaid(address indexed payer, string resourceId, uint256 amount, bool lifetime, uint256 timestamp)
      { sig: 'AccessPaid(address,string,uint256,bool,uint256)', indexed: 1, layout: 'vault' },
      // A402Verifier v2: AccessPaid(address indexed payer, address indexed creator, string resourceId, uint256 amount, bool lifetime, uint256 timestamp)
      { sig: 'AccessPaid(address,address,string,uint256,bool,uint256)', indexed: 2, layout: 'verifier' },
      // Possible: no bool
      { sig: 'AccessPaid(address,string,uint256,uint256)', indexed: 1, layout: 'simple' },
      // With nonce
      { sig: 'AccessPaid(address,string,uint256,bool,bytes32,uint256)', indexed: 1, layout: 'nonce' },
    ];

    const topicMap = {};
    for (const c of candidates) {
      topicMap['0x' + keccak256(c.sig)] = c;
    }

    // Fetch all logs from the vault
    const allLogs = await rpc('eth_getLogs', [{
      fromBlock: '0x0',
      toBlock: 'latest',
      address: vaultAddress,
    }]);

    if (!allLogs || allLogs.length === 0) {
      emptyEl.textContent = 'No events emitted by this vault yet.';
      tableWrap.innerHTML = '<div class="tx-empty">No transactions found.</div>';
      return;
    }

    // Group by topic0 to discover what events exist
    const byTopic = {};
    for (const log of allLogs) {
      const t0 = log.topics[0];
      if (!byTopic[t0]) byTopic[t0] = [];
      byTopic[t0].push(log);
    }

    // Try to find payment events — first check known signatures, then use heuristic
    let paymentLogs = [];
    let matchedCandidate = null;

    for (const [topic0, candidate] of Object.entries(topicMap)) {
      if (byTopic[topic0]) {
        paymentLogs = byTopic[topic0];
        matchedCandidate = candidate;
        break;
      }
    }

    // If no known signature matched, use heuristic: find the event topic with the most occurrences
    // that has indexed addresses (topics.length >= 2) — likely the payment event
    if (paymentLogs.length === 0) {
      let bestTopic = null, bestCount = 0;
      for (const [t0, logs] of Object.entries(byTopic)) {
        if (logs[0].topics.length >= 2 && logs.length > bestCount) {
          bestCount = logs.length;
          bestTopic = t0;
        }
      }
      if (bestTopic) {
        paymentLogs = byTopic[bestTopic];
        matchedCandidate = { sig: 'unknown', indexed: paymentLogs[0].topics.length - 1, layout: 'heuristic' };
      }
    }

    if (paymentLogs.length === 0) {
      emptyEl.textContent = 'No payment events found.';
      tableWrap.innerHTML = '<div class="tx-empty">No transactions found.</div>';
      return;
    }

    // Parse events based on layout
    allPaymentEvents = paymentLogs.map(log => {
      try {
        const payer = '0x' + log.topics[1].slice(-40);
        const data = log.data.slice(2);

        // For all layouts, we need to find: amount, timestamp, resourceId, lifetime
        // The data section contains ABI-encoded values. Dynamic string comes first (offset),
        // followed by static values.
        let amount, timestamp, lifetime, resourceId;

        if (matchedCandidate.layout === 'verifier') {
          // data: (string_offset, uint256 amount, bool lifetime, uint256 timestamp)
          amount = BigInt('0x' + data.slice(64, 128)).toString();
          lifetime = BigInt('0x' + data.slice(128, 192)) === 1n;
          timestamp = Number(BigInt('0x' + data.slice(192, 256)));
          const strOff = Number(BigInt('0x' + data.slice(0, 64))) * 2;
          const strLen = Number(BigInt('0x' + data.slice(strOff, strOff + 64)));
          resourceId = hexToString(data.slice(strOff + 64, strOff + 64 + strLen * 2));
        } else if (matchedCandidate.layout === 'vault') {
          // data: (string_offset, uint256 amount, bool lifetime, uint256 timestamp)
          amount = BigInt('0x' + data.slice(64, 128)).toString();
          lifetime = BigInt('0x' + data.slice(128, 192)) === 1n;
          timestamp = Number(BigInt('0x' + data.slice(192, 256)));
          const strOff = Number(BigInt('0x' + data.slice(0, 64))) * 2;
          const strLen = Number(BigInt('0x' + data.slice(strOff, strOff + 64)));
          resourceId = hexToString(data.slice(strOff + 64, strOff + 64 + strLen * 2));
        } else if (matchedCandidate.layout === 'simple') {
          // data: (string_offset, uint256 amount, uint256 timestamp)
          amount = BigInt('0x' + data.slice(64, 128)).toString();
          lifetime = false;
          timestamp = Number(BigInt('0x' + data.slice(128, 192)));
          const strOff = Number(BigInt('0x' + data.slice(0, 64))) * 2;
          const strLen = Number(BigInt('0x' + data.slice(strOff, strOff + 64)));
          resourceId = hexToString(data.slice(strOff + 64, strOff + 64 + strLen * 2));
        } else {
          // Heuristic: try to extract data assuming common patterns
          // Look for amount (large wei value) and timestamp (epoch seconds ~1.7B range)
          // Word 0 is usually string offset, word 1 is amount, last word is timestamp
          const wordCount = data.length / 64;
          amount = BigInt('0x' + data.slice(64, 128)).toString();
          lifetime = false;

          // Find timestamp: last few words, value in reasonable epoch range
          timestamp = 0;
          for (let w = wordCount - 1; w >= 2; w--) {
            const val = Number(BigInt('0x' + data.slice(w * 64, (w + 1) * 64)));
            if (val > 1700000000 && val < 2000000000) { timestamp = val; break; }
          }
          // Check if there's a bool before timestamp
          if (wordCount >= 4) {
            const boolWord = BigInt('0x' + data.slice(128, 192));
            if (boolWord === 0n || boolWord === 1n) lifetime = boolWord === 1n;
          }

          // Decode string
          try {
            const strOff = Number(BigInt('0x' + data.slice(0, 64))) * 2;
            const strLen = Number(BigInt('0x' + data.slice(strOff, strOff + 64)));
            resourceId = hexToString(data.slice(strOff + 64, strOff + 64 + strLen * 2));
          } catch { resourceId = '?'; }

          // If timestamp is still 0, use block timestamp lookup (fallback)
          if (timestamp === 0) timestamp = Math.floor(Date.now() / 1000);
        }

        return {
          payer, resourceId, amount, lifetime, timestamp,
          txHash: log.transactionHash,
          blockNumber: Number(BigInt(log.blockNumber)),
        };
      } catch (e) {
        return null;
      }
    }).filter(Boolean).sort((a, b) => b.timestamp - a.timestamp);

    document.getElementById('csvBtn').disabled = allPaymentEvents.length === 0;

    // Cross-reference lifetime status from on-chain resource config
    // The event bool may not reflect actual lifetime setting, so we check getResource()
    await enrichLifetimeStatus();

    renderChart();
    renderTxTable();

  } catch (err) {
    emptyEl.textContent = 'Failed to load events: ' + err.message;
    tableWrap.innerHTML = `<div class="tx-empty" style="color:var(--red);">Error: ${err.message}</div>`;
  }
}

// ── Enrich lifetime status from on-chain resource config ──
async function enrichLifetimeStatus() {
  // Collect unique resourceIds from events
  const resourceIds = [...new Set(allPaymentEvents.map(e => e.resourceId))];
  const lifetimeMap = {};

  for (const resId of resourceIds) {
    try {
      const s = selector('getResource(string)');
      const data = '0x' + s + padUint(32) + encodeString(resId);
      const result = await ethCall(vaultAddress, data);
      const d = result.slice(2);
      // Word 1 = lifetime (bool)
      lifetimeMap[resId] = BigInt('0x' + d.slice(64, 128)) === 1n;
    } catch {
      lifetimeMap[resId] = false;
    }
  }

  // Update events with accurate lifetime status
  for (const e of allPaymentEvents) {
    if (lifetimeMap[e.resourceId] !== undefined) {
      e.lifetime = lifetimeMap[e.resourceId];
    }
  }
}

// ── Date filter ──
function setChartRange(days, el) {
  chartRange = days;
  document.querySelectorAll('#chartFilterBar .filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  txPage = 0;
  renderChart();
  renderTxTable();
}

function getFilteredEvents() {
  if (chartRange === 0) return allPaymentEvents;
  const cutoff = Math.floor(Date.now() / 1000) - (chartRange * 86400);
  return allPaymentEvents.filter(e => e.timestamp >= cutoff);
}

// ── Canvas chart ──
function renderChart() {
  const events = getFilteredEvents();
  const canvas = document.getElementById('revenueChart');
  const emptyEl = document.getElementById('chartEmpty');
  const legendEl = document.getElementById('chartLegend');
  const countEl = document.getElementById('chartTxCount');

  countEl.textContent = events.length + ' payment' + (events.length !== 1 ? 's' : '');

  if (events.length === 0) {
    canvas.style.display = 'none';
    emptyEl.style.display = 'flex';
    emptyEl.textContent = 'No payments in this period.';
    legendEl.style.display = 'none';
    return;
  }

  canvas.style.display = 'block';
  emptyEl.style.display = 'none';
  legendEl.style.display = 'flex';

  // Bucket by day
  const buckets = {};
  for (const e of events) {
    const d = new Date(e.timestamp * 1000);
    const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    if (!buckets[key]) buckets[key] = { revenue: 0n, payments: 0 };
    buckets[key].revenue += BigInt(e.amount);
    buckets[key].payments += 1;
  }

  // Fill gaps
  const sortedKeys = Object.keys(buckets).sort();
  const startDate = new Date(sortedKeys[0] + 'T00:00:00');
  const endDate = new Date(sortedKeys[sortedKeys.length - 1] + 'T00:00:00');
  const labels = [];
  const revData = [];
  const payData = [];
  for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
    const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    labels.push(String(d.getMonth() + 1) + '/' + String(d.getDate()));
    const b = buckets[key];
    if (b) {
      // Convert revenue to float APTM
      const weiStr = b.revenue.toString().padStart(19, '0');
      const whole = weiStr.slice(0, -18) || '0';
      const frac = weiStr.slice(-18).slice(0, 6);
      revData.push(parseFloat(whole + '.' + frac));
      payData.push(b.payments);
    } else {
      revData.push(0);
      payData.push(0);
    }
  }

  // Draw
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  const ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  const W = rect.width;
  const H = rect.height;

  ctx.clearRect(0, 0, W, H);

  const pad = { top: 20, right: 14, bottom: 28, left: 52 };
  const cW = W - pad.left - pad.right;
  const cH = H - pad.top - pad.bottom;

  const maxRev = Math.max(...revData, 0.001);
  const maxPay = Math.max(...payData, 1);
  const n = labels.length;

  // Grid lines
  ctx.strokeStyle = 'rgba(255,255,255,0.04)';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + (cH / 4) * i;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
  }

  // Y-axis labels (revenue)
  ctx.font = '10px monospace';
  ctx.fillStyle = '#5c6478';
  ctx.textAlign = 'right';
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + (cH / 4) * i;
    const val = maxRev * (1 - i / 4);
    ctx.fillText(val.toFixed(val >= 1 ? 2 : 4), pad.left - 6, y + 3);
  }

  // X-axis labels
  ctx.textAlign = 'center';
  const labelStep = Math.max(1, Math.floor(n / 8));
  for (let i = 0; i < n; i += labelStep) {
    const x = pad.left + (i / Math.max(n - 1, 1)) * cW;
    ctx.fillText(labels[i], x, H - 6);
  }

  if (n === 1) {
    // Single bar
    const barW = Math.min(cW * 0.3, 40);
    const x = pad.left + cW / 2;
    const rH = (revData[0] / maxRev) * cH;
    ctx.fillStyle = 'rgba(90,148,245,0.5)';
    ctx.fillRect(x - barW / 2, pad.top + cH - rH, barW, rH);
    // Payment count as dot
    const pH = (payData[0] / maxPay) * cH;
    ctx.fillStyle = '#22c55e';
    ctx.beginPath();
    ctx.arc(x, pad.top + cH - pH, 4, 0, Math.PI * 2);
    ctx.fill();
    return;
  }

  // Revenue area fill
  ctx.beginPath();
  ctx.moveTo(pad.left, pad.top + cH);
  for (let i = 0; i < n; i++) {
    const x = pad.left + (i / (n - 1)) * cW;
    const y = pad.top + cH - (revData[i] / maxRev) * cH;
    if (i === 0) ctx.lineTo(x, y); else ctx.lineTo(x, y);
  }
  ctx.lineTo(pad.left + cW, pad.top + cH);
  ctx.closePath();
  const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + cH);
  grad.addColorStop(0, 'rgba(90,148,245,0.25)');
  grad.addColorStop(1, 'rgba(90,148,245,0.01)');
  ctx.fillStyle = grad;
  ctx.fill();

  // Revenue line
  ctx.beginPath();
  for (let i = 0; i < n; i++) {
    const x = pad.left + (i / (n - 1)) * cW;
    const y = pad.top + cH - (revData[i] / maxRev) * cH;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  }
  ctx.strokeStyle = '#5a94f5';
  ctx.lineWidth = 2;
  ctx.stroke();

  // Payment dots
  for (let i = 0; i < n; i++) {
    if (payData[i] === 0) continue;
    const x = pad.left + (i / (n - 1)) * cW;
    const y = pad.top + cH - (payData[i] / maxPay) * cH;
    ctx.fillStyle = '#22c55e';
    ctx.beginPath();
    ctx.arc(x, y, 3, 0, Math.PI * 2);
    ctx.fill();
  }
}

// ── Transaction table ──
function renderTxTable() {
  const events = getFilteredEvents();
  const wrap = document.getElementById('txTableWrap');

  if (events.length === 0) {
    wrap.innerHTML = '<div class="tx-empty">No transactions in this period.</div>';
    return;
  }

  const start = txPage * TX_PER_PAGE;
  const page = events.slice(start, start + TX_PER_PAGE);
  const totalPages = Math.ceil(events.length / TX_PER_PAGE);

  let html = `<table class="tx-table">
    <thead><tr>
      <th>Payer</th><th>Resource</th><th>Amount</th><th>Access</th><th>Time</th><th>Tx</th>
    </tr></thead><tbody>`;

  for (const e of page) {
    const shortAddr = e.payer.slice(0, 6) + '...' + e.payer.slice(-4);
    const shortTx = e.txHash.slice(0, 8) + '...';
    const dateStr = new Date(e.timestamp * 1000).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    html += `<tr>
      <td><a class="addr" href="${EXPLORER}/address/${e.payer}" target="_blank">${shortAddr}</a></td>
      <td><span class="res-tag">${e.resourceId}</span></td>
      <td class="amt">${fromWei(e.amount)} APTM</td>
      <td>${e.lifetime ? '♾ Lifetime' : 'Per-access'}</td>
      <td class="time">${dateStr}</td>
      <td><a class="addr" href="${EXPLORER}/tx/${e.txHash}" target="_blank">${shortTx}</a></td>
    </tr>`;
  }

  html += '</tbody></table>';

  // Pagination
  if (totalPages > 1) {
    html += `<div class="tx-pagination">
      <button onclick="txPage--;renderTxTable();" ${txPage === 0 ? 'disabled' : ''}>← Prev</button>
      <span>${txPage + 1} / ${totalPages}</span>
      <button onclick="txPage++;renderTxTable();" ${txPage >= totalPages - 1 ? 'disabled' : ''}>Next →</button>
    </div>`;
  }

  wrap.innerHTML = html;
}

// ── CSV Export ──
function exportCSV() {
  const events = getFilteredEvents();
  if (events.length === 0) return;

  let csv = 'Payer,Resource,Amount_APTM,Amount_Wei,Lifetime,Timestamp_UTC,Tx_Hash,Block\n';
  for (const e of events) {
    const date = new Date(e.timestamp * 1000).toISOString();
    csv += `${e.payer},${e.resourceId},${fromWei(e.amount)},${e.amount},${e.lifetime},${date},${e.txHash},${e.blockNumber}\n`;
  }

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `a402-revenue-${vaultAddress.slice(0, 8)}-${new Date().toISOString().slice(0, 10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// ═══════════════════════════════════════════════════════════════
//  WITHDRAW
// ═══════════════════════════════════════════════════════════════

async function withdrawAll() {
  const btn = document.getElementById('withdrawBtn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Withdrawing...';
  setStatus('withdrawStatus', 'pending', 'Confirm the transaction in your wallet...');

  try {
    const sel = selector('withdraw()');
    const txHash = await window.ethereum.request({
      method: 'eth_sendTransaction',
      params: [{ from: userAddress, to: vaultAddress, data: '0x' + sel }],
    });

    setStatus('withdrawStatus', 'pending', 'Transaction sent...');

    let receipt = null;
    for (let i = 0; i < 30; i++) {
      await new Promise(r => setTimeout(r, 1500));
      receipt = await rpc('eth_getTransactionReceipt', [txHash]);
      if (receipt) break;
    }

    if (!receipt || receipt.status !== '0x1') throw new Error('Transaction reverted');

    setStatus('withdrawStatus', 'success',
      '✓ Withdrawn! <a href="' + EXPLORER + '/tx/' + txHash + '" target="_blank">View transaction</a>');

    // Refresh stats
    await loadRevenue();

  } catch (err) {
    setStatus('withdrawStatus', 'error', err.code === 4001 ? 'Transaction rejected.' : 'Failed: ' + err.message);
    btn.disabled = false;
    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Withdraw All';
  }
}

// ═══════════════════════════════════════════════════════════════
//  PAUSE/UNPAUSE
// ═══════════════════════════════════════════════════════════════

async function togglePause(resourceId, shouldPause) {
  const fn = shouldPause ? 'pauseResource(string)' : 'unpauseResource(string)';
  const sel = selector(fn);
  const encoded = '0x' + sel + padUint(32) + encodeString(resourceId);

  try {
    const txHash = await window.ethereum.request({
      method: 'eth_sendTransaction',
      params: [{ from: userAddress, to: vaultAddress, data: encoded }],
    });
    for (let i = 0; i < 20; i++) {
      await new Promise(r => setTimeout(r, 1500));
      const receipt = await rpc('eth_getTransactionReceipt', [txHash]);
      if (receipt) break;
    }
    loadMyContent();
  } catch (err) {
    if (err.code !== 4001) alert('Failed: ' + err.message);
  }
}

// ═══════════════════════════════════════════════════════════════
//  INLINE EDIT
// ═══════════════════════════════════════════════════════════════

// Track original values so we only send txs for what changed
let editOriginals = {};

async function openEdit(resourceId) {
  // Close any other open edits
  document.querySelectorAll('.res-edit.open').forEach(el => el.classList.remove('open'));

  const panel = document.getElementById('edit-' + resourceId);
  panel.classList.add('open');

  // Fetch contentRef via getResource(string) since getResourceByIndex doesn't return it
  const refInput = document.getElementById('editRef-' + resourceId);
  refInput.value = 'Loading...';
  refInput.disabled = true;

  try {
    const s = selector('getResource(string)');
    const data = '0x' + s + padUint(32) + encodeString(resourceId);
    const result = await ethCall(vaultAddress, data);
    const d = result.slice(2);

    // Decode contentRef (offset at word 5, index 320)
    const refOff = Number(BigInt('0x' + d.slice(320, 384))) * 2;
    const refLen = Number(BigInt('0x' + d.slice(refOff, refOff + 64)));
    const refHex = d.slice(refOff + 64, refOff + 64 + refLen * 2);
    const contentRef = hexToString(refHex);

    refInput.value = contentRef;
    refInput.disabled = false;

    // Store originals
    const priceInput = document.getElementById('editPrice-' + resourceId);
    const lifetimeEl = document.getElementById('editLifetime-' + resourceId);
    editOriginals[resourceId] = {
      price: priceInput.value,
      lifetime: lifetimeEl.classList.contains('on'),
      contentRef: contentRef,
    };
  } catch (err) {
    refInput.value = '';
    refInput.disabled = false;
    refInput.placeholder = 'Failed to load — enter manually';
  }
}

function closeEdit(resourceId) {
  document.getElementById('edit-' + resourceId).classList.remove('open');
  // Clear status
  const st = document.getElementById('editStatus-' + resourceId);
  st.className = 'edit-status';
}

function toggleEditLifetime(resourceId) {
  const el = document.getElementById('editLifetime-' + resourceId);
  el.classList.toggle('on');
  el.querySelector('span').textContent = el.classList.contains('on') ? 'Lifetime' : 'Per-access';
}

async function saveEdit(resourceId) {
  const btn = document.getElementById('editSaveBtn-' + resourceId);
  const statusEl = document.getElementById('editStatus-' + resourceId);
  const orig = editOriginals[resourceId];

  const newPrice = document.getElementById('editPrice-' + resourceId).value;
  const newLifetime = document.getElementById('editLifetime-' + resourceId).classList.contains('on');
  const newRef = document.getElementById('editRef-' + resourceId).value.trim();

  if (!newPrice || parseFloat(newPrice) <= 0) {
    statusEl.className = 'edit-status show error';
    statusEl.textContent = 'Price must be greater than 0.';
    return;
  }

  const priceChanged = newPrice !== orig.price;
  const lifetimeChanged = newLifetime !== orig.lifetime;
  const refChanged = newRef !== orig.contentRef;

  // V2: check if token prices changed
  let hasTokenChanges = false;
  if (vaultVersion >= 2) {
    const inputs = document.querySelectorAll(`#editTokenInputs-${resourceId} input[data-token]`);
    for (const inp of inputs) {
      const val = parseFloat(inp.value);
      const existing = (tokenPrices[resourceId] || []).find(t => t.token.toLowerCase() === inp.dataset.token.toLowerCase());
      const existingVal = existing ? formatTokenAmount(existing.price, parseInt(inp.dataset.decimals)) : '0';
      const newVal = val > 0 ? val.toString() : '0';
      if (newVal !== existingVal) { hasTokenChanges = true; break; }
    }
  }

  if (!priceChanged && !lifetimeChanged && !refChanged && !hasTokenChanges) {
    statusEl.className = 'edit-status show error';
    statusEl.textContent = 'No changes to save.';
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Saving...';

  try {
    // If price or lifetime changed → updateResource(string, uint256, bool)
    if (priceChanged || lifetimeChanged) {
      statusEl.className = 'edit-status show pending';
      statusEl.textContent = 'Updating price & access — confirm in wallet...';

      const s = selector('updateResource(string,uint256,bool)');
      const priceWei = toWei(newPrice);
      const data = '0x' + s +
        padUint(96) +              // offset to string
        padUint(priceWei) +        // newPrice
        padBool(newLifetime) +     // lifetimeAccess
        encodeString(resourceId);

      const txHash = await window.ethereum.request({
        method: 'eth_sendTransaction',
        params: [{ from: userAddress, to: vaultAddress, data }],
      });

      for (let i = 0; i < 25; i++) {
        await new Promise(r => setTimeout(r, 1500));
        const receipt = await rpc('eth_getTransactionReceipt', [txHash]);
        if (receipt) {
          if (receipt.status !== '0x1') throw new Error('updateResource tx reverted');
          break;
        }
      }
    }

    // If contentRef changed → updateContentRef(string, string)
    if (refChanged) {
      statusEl.className = 'edit-status show pending';
      statusEl.textContent = 'Updating content ref — confirm in wallet...';

      const s = selector('updateContentRef(string,string)');
      // Two dynamic strings: resourceId at offset, newContentRef at offset
      const resBytes = encodeString(resourceId);
      const refBytes = encodeString(newRef);
      const headSize = 64; // 2 offset slots
      const resSize = resBytes.length / 2; // in bytes

      const data = '0x' + s +
        padUint(headSize) +                      // offset to resourceId
        padUint(headSize + resSize) +             // offset to newContentRef
        resBytes +
        refBytes;

      const txHash = await window.ethereum.request({
        method: 'eth_sendTransaction',
        params: [{ from: userAddress, to: vaultAddress, data }],
      });

      for (let i = 0; i < 25; i++) {
        await new Promise(r => setTimeout(r, 1500));
        const receipt = await rpc('eth_getTransactionReceipt', [txHash]);
        if (receipt) {
          if (receipt.status !== '0x1') throw new Error('updateContentRef tx reverted');
          break;
        }
      }
    }

    // V2: Save token prices if changed
    if (hasTokenChanges) {
      statusEl.className = 'edit-status show pending';
      statusEl.textContent = 'Updating token prices — confirm in wallet...';
      await saveTokenPriceEdits(resourceId);
    }

    statusEl.className = 'edit-status show success';
    statusEl.textContent = '✓ Updated on-chain!';
    setTimeout(() => loadMyContent(), 1200);

  } catch (err) {
    statusEl.className = 'edit-status show error';
    statusEl.textContent = err.code === 4001 ? 'Transaction rejected.' : 'Failed: ' + err.message;
    btn.disabled = false;
    btn.textContent = 'Save Changes';
  }
}

// ═══════════════════════════════════════════════════════════════
//  EMBED DROPDOWN
// ═══════════════════════════════════════════════════════════════

function toggleEmbedDropdown(resourceId, e) {
  e.stopPropagation();
  // Close any other open dropdowns
  document.querySelectorAll('.embed-dropdown.open').forEach(d => {
    if (d.id !== 'embedDrop-' + resourceId) d.classList.remove('open');
  });
  const dd = document.getElementById('embedDrop-' + resourceId);
  dd.classList.toggle('open');
}

// Close dropdowns when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('.embed-wrap')) {
    document.querySelectorAll('.embed-dropdown.open').forEach(d => d.classList.remove('open'));
  }
});

function copyEmbedFormat(resourceId, format, btnEl, e) {
  e.stopPropagation();
  const url = `${window.location.origin}/watch.html?vault=${vaultAddress}&resource=${resourceId}`;
  let text = '';

  if (format === 'link') {
    text = url;
  } else if (format === 'iframe') {
    text = `<iframe src="${url}"\n  width="640" height="400" frameborder="0"\n  allow="ethereum *">\n</iframe>`;
  } else if (format === 'script') {
    text = `<div class="a402-content"\n  data-vault="${vaultAddress}"\n  data-resource="${resourceId}">\n</div>\n<script src="https://cdn.a402.io/embed.js"><\/script>`;
  }

  navigator.clipboard.writeText(text);

  // Show preview
  const preview = document.getElementById('embedPreview-' + resourceId);
  preview.textContent = text;
  preview.classList.add('show');

  // Flash the button
  btnEl.textContent = 'Copied!';
  btnEl.classList.add('copied');
  setTimeout(() => { btnEl.textContent = 'Copy'; btnEl.classList.remove('copied'); }, 1800);
}

function copyEmbed(resourceId) {
  const url = `${window.location.origin}/watch.html?vault=${vaultAddress}&resource=${resourceId}`;
  navigator.clipboard.writeText(url);
  alert('Viewer link copied!\n\n' + url);
}

function copyText(id) {
  const text = document.getElementById(id).textContent;
  navigator.clipboard.writeText(text);
}

// ═══════════════════════════════════════════════════════════════
//  UTILITIES
// ═══════════════════════════════════════════════════════════════

function setStatus(id, type, msg) {
  const el = document.getElementById(id);
  el.className = 'status-bar show ' + type;
  el.innerHTML = msg;
}

// ─── Wallet events ───
if (window.ethereum) {
  window.ethereum.on('accountsChanged', (accounts) => {
    if (accounts.length === 0) window.location.reload();
    else if (accounts[0].toLowerCase() !== userAddress?.toLowerCase()) window.location.reload();
  });
  window.ethereum.on('chainChanged', () => window.location.reload());

  // Auto-reconnect on page load
  (async () => {
    try {
      const accounts = await window.ethereum.request({ method: 'eth_accounts' });
      if (accounts.length > 0) {
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        if (chainId === CHAIN_HEX) {
          userAddress = accounts[0];
          const hasVaultSel = selector('hasVault(address)');
          const hasVaultData = '0x' + hasVaultSel + padAddr(userAddress);
          const hasVaultResult = await ethCall(FACTORY, hasVaultData);
          if (BigInt(hasVaultResult) === 1n) {
            const getVaultSel = selector('getVault(address)');
            const getVaultData = '0x' + getVaultSel + padAddr(userAddress);
            const vaultResult = await ethCall(FACTORY, getVaultData);
            vaultAddress = '0x' + vaultResult.slice(-40);
            await detectVaultVersion();
            await loadAllowedTokens();
            enterDashboard();
          }
        }
      }
    } catch { /* silent fail — user will manually connect */ }
  })();
}
</script>
</body>
</html>
