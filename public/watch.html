<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A402 · Pay to Watch</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha3/0.9.3/sha3.min.js"></script>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #060709; --bg-card: #0c1018; --border: #1c2233;
      --text: #b8bfce; --text-dim: #5c6478; --text-bright: #eaf0f9;
      --blue: #3272e8; --blue-light: #5a94f5; --blue-glow: rgba(50,114,232,0.12);
      --green: #22c55e; --green-glow: rgba(34,197,94,0.1);
      --amber: #eab308; --amber-glow: rgba(234,179,8,0.08);
      --red: #ef4444; --text-muted: #3a4052;
      --mono: 'JetBrains Mono', monospace; --sans: 'Sora', sans-serif;
    }
    body { background: var(--bg); color: var(--text); font-family: var(--sans); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 24px; }

    .container { max-width: 680px; width: 100%; }
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-mark { width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, var(--blue), #8b5cf6); display: grid; place-items: center; font-family: var(--mono); font-size: 13px; font-weight: 600; color: #fff; }
    .logo-text { font-family: var(--mono); font-size: 12px; font-weight: 600; color: var(--text-bright); }
    .logo-text small { color: var(--text-dim); font-weight: 400; }
    .chain-tag { font-family: var(--mono); font-size: 10px; padding: 5px 10px; border-radius: 14px; border: 1px solid var(--border); color: var(--text-dim); display: flex; align-items: center; gap: 5px; }
    .chain-tag .dot { width: 5px; height: 5px; border-radius: 50%; background: var(--green); animation: pulse 2.5s ease infinite; }
    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
    .video-area { position: relative; width: 100%; aspect-ratio: 16/9; background: #000; overflow: hidden; }
    .video-area iframe { width: 100%; height: 100%; border: none; }

    /* ── Custom player controls ── */
    .player-wrap { position: relative; width: 100%; height: 100%; }
    .player-wrap iframe { width: 100%; height: 100%; border: none; pointer-events: none; }
    .player-click-zone { position: absolute; inset: 0; z-index: 2; cursor: pointer; }
    .player-controls {
      position: absolute; bottom: 0; left: 0; right: 0; z-index: 3;
      background: linear-gradient(0deg, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.4) 60%, transparent 100%);
      padding: 32px 14px 12px; display: flex; flex-direction: column; gap: 8px;
      opacity: 0; transition: opacity 0.25s ease;
    }
    .player-wrap:hover .player-controls,
    .player-wrap.paused .player-controls { opacity: 1; }
    .player-controls.force-show { opacity: 1; }

    .seek-row { display: flex; align-items: center; gap: 0; width: 100%; }
    .seek-bar {
      -webkit-appearance: none; appearance: none;
      width: 100%; height: 4px; border-radius: 2px;
      background: rgba(255,255,255,0.15); outline: none; cursor: pointer;
      transition: height 0.15s ease;
    }
    .seek-bar:hover { height: 6px; }
    .seek-bar::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none;
      width: 14px; height: 14px; border-radius: 50%;
      background: var(--blue-light); border: 2px solid #fff;
      cursor: pointer; box-shadow: 0 0 6px rgba(0,0,0,0.4);
      transition: transform 0.15s ease;
    }
    .seek-bar:hover::-webkit-slider-thumb { transform: scale(1.2); }
    .seek-bar::-moz-range-thumb {
      width: 14px; height: 14px; border-radius: 50%;
      background: var(--blue-light); border: 2px solid #fff;
      cursor: pointer;
    }

    .ctrl-row { display: flex; align-items: center; gap: 10px; }
    .ctrl-btn {
      background: none; border: none; cursor: pointer; padding: 4px;
      display: grid; place-items: center; border-radius: 4px;
      transition: background 0.15s;
    }
    .ctrl-btn:hover { background: rgba(255,255,255,0.1); }
    .ctrl-btn svg { width: 20px; height: 20px; fill: #fff; stroke: none; }
    .ctrl-btn.small svg { width: 18px; height: 18px; }

    .time-display {
      font-family: var(--mono); font-size: 11px; color: rgba(255,255,255,0.7);
      user-select: none; white-space: nowrap;
    }

    .vol-group { display: flex; align-items: center; gap: 4px; }
    .vol-bar {
      -webkit-appearance: none; appearance: none;
      width: 60px; height: 3px; border-radius: 2px;
      background: rgba(255,255,255,0.2); outline: none; cursor: pointer;
    }
    .vol-bar::-webkit-slider-thumb {
      -webkit-appearance: none; width: 10px; height: 10px;
      border-radius: 50%; background: #fff; cursor: pointer;
    }
    .vol-bar::-moz-range-thumb { width: 10px; height: 10px; border-radius: 50%; background: #fff; }

    .ctrl-spacer { flex: 1; }

    /* Big center play button when paused */
    .center-play {
      position: absolute; top: 50%; left: 50%; z-index: 4;
      transform: translate(-50%, -50%);
      width: 64px; height: 64px; border-radius: 50%;
      background: rgba(0,0,0,0.55); border: 2px solid rgba(255,255,255,0.15);
      display: none; place-items: center; cursor: pointer;
      backdrop-filter: blur(8px);
      transition: transform 0.15s ease, background 0.15s ease;
    }
    .center-play:hover { background: rgba(50,114,232,0.6); transform: translate(-50%, -50%) scale(1.08); }
    .center-play svg { width: 28px; height: 28px; fill: #fff; stroke: none; margin-left: 3px; }
    .player-wrap.paused .center-play { display: grid; }

    .lock-overlay {
      position: absolute; inset: 0;
      background: linear-gradient(180deg, rgba(6,7,9,0.5), rgba(6,7,9,0.95));
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 14px;
      backdrop-filter: blur(6px); transition: opacity 0.4s, visibility 0.4s;
    }
    .lock-overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    .lock-icon { width: 56px; height: 56px; border-radius: 50%; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); display: grid; place-items: center; }
    .lock-icon svg { width: 24px; height: 24px; stroke: var(--blue-light); fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    .lock-text { font-size: 13px; color: var(--text-dim); text-align: center; }
    .lock-text strong { color: var(--text-bright); }

    .body { padding: 24px; transition: padding 0.4s ease; }
    .title { font-size: 18px; font-weight: 600; color: var(--text-bright); margin-bottom: 6px; }
    .desc { font-size: 13px; color: var(--text-dim); margin-bottom: 20px; }

    /* ── Minimal post-unlock state ── */
    .container.unlocked { max-width: 900px; }
    .body.minimal { padding: 12px 16px; }
    .body.minimal .desc,
    .body.minimal .price-row,
    .body.minimal .chips,
    .body.minimal .status,
    .body.minimal .tx-link { display: none !important; }
    .body.minimal .title { font-size: 14px; margin-bottom: 0; }

    .minimal-bar {
      display: none; align-items: center; gap: 10px;
      font-family: var(--mono); font-size: 11px;
    }
    .body.minimal .minimal-bar { display: flex; }

    .minimal-bar .verified-pill {
      display: flex; align-items: center; gap: 4px;
      padding: 3px 8px; border-radius: 10px;
      background: var(--green-glow); border: 1px solid rgba(34,197,94,0.12);
      color: var(--green); font-size: 10px; font-weight: 500;
    }
    .minimal-bar .verified-pill svg { width: 11px; height: 11px; stroke: var(--green); fill: none; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; }

    .minimal-bar .a402-tag {
      margin-left: auto;
      color: var(--text-muted); font-size: 10px;
    }
    .minimal-bar .a402-tag a { color: var(--text-dim); text-decoration: none; }
    .minimal-bar .a402-tag a:hover { color: var(--blue-light); }

    .price-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 16px; border-radius: 10px;
      background: var(--blue-glow); border: 1px solid rgba(50,114,232,0.1);
      margin-bottom: 18px;
    }
    .price-label { font-family: var(--mono); font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); }
    .price-value { font-family: var(--mono); font-size: 18px; font-weight: 600; color: var(--text-bright); }
    .price-value .cur { font-size: 11px; color: var(--blue-light); margin-left: 3px; }

    .chips { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 18px; }
    .chip { font-family: var(--mono); font-size: 10px; padding: 4px 8px; border-radius: 5px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); color: var(--text-dim); }
    .chip strong { color: var(--text); }
    .chip.lifetime { border-color: rgba(34,197,94,0.2); background: var(--green-glow); }
    .chip.lifetime strong { color: var(--green); }

    .btn {
      width: 100%; padding: 14px; border: none; border-radius: 10px;
      font-family: var(--sans); font-size: 13px; font-weight: 600;
      cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: all 0.15s;
    }
    .btn-primary { background: linear-gradient(135deg, var(--blue), #4a6af5); color: #fff; }
    .btn-primary:hover { transform: translateY(-1px); }
    .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
    .btn-success { background: var(--green); color: #000; }
    .btn svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
    .spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.2); border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .status {
      margin-top: 14px; padding: 12px 14px; border-radius: 8px;
      font-family: var(--mono); font-size: 11.5px; line-height: 1.5; display: none;
    }
    .status.show { display: block; }
    .status.info { background: var(--blue-glow); border: 1px solid rgba(50,114,232,0.12); color: var(--blue-light); }
    .status.success { background: var(--green-glow); border: 1px solid rgba(34,197,94,0.12); color: var(--green); }
    .status.error { background: rgba(239,68,68,0.06); border: 1px solid rgba(239,68,68,0.12); color: var(--red); }
    .status.pending { background: var(--amber-glow); border: 1px solid rgba(234,179,8,0.12); color: var(--amber); }
    .status a { color: inherit; }

    .tx-link { margin-top: 10px; font-family: var(--mono); font-size: 11px; display: none; }
    .tx-link.show { display: block; }
    .tx-link a { color: var(--blue-light); text-decoration: none; word-break: break-all; }

    .footer { text-align: center; margin-top: 24px; font-size: 11px; color: var(--text-dim); font-family: var(--mono); }
    .footer a { color: var(--blue); text-decoration: none; }

    .error-screen { text-align: center; padding: 60px 24px; }
    .error-screen h1 { font-size: 20px; color: var(--text-bright); margin-bottom: 8px; }
    .error-screen p { font-size: 13px; color: var(--text-dim); }

    /* ── HTML5 video player (IPFS/direct) ── */
    #html5Video {
      background: #000;
    }
    .video-error {
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      background: var(--bg-card);
    }

    /* ── Download protection ── */
    video::-webkit-media-controls-download-button { display: none !important; }
    video::-webkit-media-controls-overflow-button { display: none !important; }
    video::-internal-media-controls-download-button { display: none !important; }
    video { -webkit-user-drag: none; user-drag: none; }
    .video-area { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <div class="logo-mark">A</div>
        <div class="logo-text">apertum<small>/x402</small></div>
      </div>
      <div class="chain-tag"><div class="dot"></div>eip155:2786</div>
    </div>

    <div id="errorScreen" class="error-screen" style="display:none;">
      <h1>Invalid Link</h1>
      <p>This page requires <code>?vault=0x...&resource=...</code> URL parameters.</p>
    </div>

    <div class="card" id="mainCard" style="display:none;">
      <div class="video-area" id="videoArea">
        <div class="lock-overlay" id="lockOverlay">
          <div class="lock-icon">
            <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          </div>
          <div class="lock-text"><strong>Content Locked</strong><br>Pay via A402 contract to unlock</div>
        </div>
      </div>
      <div class="body">
        <div class="title" id="resTitle">Loading...</div>
        <div class="desc" id="resDesc">Fetching resource details from chain...</div>
        <div class="price-row">
          <span class="price-label">Price</span>
          <span class="price-value" id="priceDisplay">—<span class="cur">APTM</span></span>
        </div>
        <div class="price-row" id="gasRow" style="display:none; background:rgba(255,255,255,0.02); border-color:var(--border);">
          <span class="price-label">Est. Gas Fee</span>
          <span class="price-value" id="gasDisplay" style="font-size:14px; color:var(--text);">—<span class="cur">APTM</span></span>
        </div>
        <div class="price-row" id="totalRow" style="display:none; background:rgba(34,197,94,0.04); border-color:rgba(34,197,94,0.12);">
          <span class="price-label" style="color:var(--green);">Total Cost</span>
          <span class="price-value" id="totalDisplay" style="font-size:18px; color:var(--green);">—<span class="cur" style="color:var(--green);">APTM</span></span>
        </div>
        <div id="tokenSelectorRow" style="display:none; margin-bottom:14px;">
          <div style="font-family:var(--mono);font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:8px;">Pay With</div>
          <div id="tokenButtons" style="display:flex;gap:6px;flex-wrap:wrap;"></div>
        </div>
        <div class="chips" id="chipRow"></div>
        <button class="btn btn-primary" id="actionBtn" onclick="handleAction()">
          <svg viewBox="0 0 24 24"><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"/><circle cx="18" cy="16" r="2"/></svg>
          Connect Wallet
        </button>
        <div class="status" id="statusMsg"></div>
        <div class="tx-link" id="txLink"></div>
        <div class="minimal-bar">
          <span class="verified-pill">
            <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
            <span id="minimalLabel">Verified</span>
          </span>
          <span class="a402-tag"><a href="https://apertum.io" target="_blank">A402 · Apertum</a></span>
        </div>
      </div>
    </div>

    <div class="footer">
      Built on <a href="https://apertum.io" target="_blank">Apertum</a> ·
      <a href="https://github.com/coinbase/x402" target="_blank">x402 Standard</a>
    </div>
  </div>

<script>
const RPC = 'https://rpc.apertum.io/ext/bc/YDJ1r9RMkewATmA7B35q1bdV18aywzmdiXwd9zGBq3uQjsCnn/rpc';
const CHAIN_HEX = '0xae2';
const EXPLORER = 'https://explorer.apertum.io';
const IPFS_GATEWAY = 'https://ipfs.io';
const FACTORY = '0x88408192d8548CD864f58E7d3c6f97fD577d4451';

const TOKEN_META_BY_SYMBOL = {
  'wUSDT': { name: 'Wrapped USDT', icon: 'https://assets.apertum.io/assets/wusdt-aptm.svg' },
  'USDC':  { name: 'USD Coin',     icon: 'https://assets.apertum.io/assets/wusdt-aptm.svg' },
};
function getTokenMeta(symbol) { return TOKEN_META_BY_SYMBOL[symbol] || null; }
const APTM_ICON = 'https://assets.apertum.io/assets/apertum-logo.svg';

// Parse URL params
const params = new URLSearchParams(window.location.search);
const VAULT = params.get('vault');
const RESOURCE = params.get('resource');

let userAddress = null;
let resourceConfig = null; // { price, lifetime, active, exists, contentType, contentRef }
let state = 'disconnected';
let vaultVersion = 1;
let acceptedTokens = [];   // [{token, symbol, decimals, price}]
let selectedPayment = 'native'; // 'native' or token address


function sel(sig) { return keccak256(sig).slice(0, 8); }
function pad32(h) { return h.replace('0x','').padStart(64,'0'); }
function padAddr(a) { return pad32(a.replace('0x','').toLowerCase()); }
function padUint(n) { return BigInt(n).toString(16).padStart(64,'0'); }
function encStr(s) { const b=new TextEncoder().encode(s); let h=''; for(const c of b) h+=c.toString(16).padStart(2,'0'); return padUint(b.length)+h.padEnd(Math.ceil(h.length/64)*64,'0'); }
function hexStr(h) { let s=''; for(let i=0;i<h.length;i+=2) s+=String.fromCharCode(parseInt(h.slice(i,i+2),16)); return s; }
function fromWei(w) { const s=BigInt(w).toString().padStart(19,'0'); const whole=s.slice(0,-18)||'0'; const frac=s.slice(-18).replace(/0+$/,''); return frac?`${whole}.${frac}`:whole; }
function fmtTokAmt(w,dec) { const s=BigInt(w).toString().padStart(dec+1,'0'); const whole=s.slice(0,-dec)||'0'; const frac=s.slice(-dec).replace(/0+$/,''); return frac?`${whole}.${frac}`:whole; }

async function getVaultVer() { try { const s=sel('version()'); const r=await ethCall(VAULT,'0x'+s); return Number(BigInt(r)); } catch { return 1; } }

async function getAcceptedToks(resourceId) {
  try {
    const s=sel('getAcceptedTokens(string)'); const data='0x'+s+padUint(32)+encStr(resourceId);
    const r=await ethCall(VAULT,data); const d=r.slice(2); if(d.length<128) return [];
    const off0=Number(BigInt('0x'+d.slice(0,64)))*2; const off1=Number(BigInt('0x'+d.slice(64,128)))*2;
    const tc=Number(BigInt('0x'+d.slice(off0,off0+64))); const toks=[];
    for(let i=0;i<tc;i++) toks.push('0x'+d.slice(off0+64+i*64+24,off0+64+(i+1)*64));
    const pc=Number(BigInt('0x'+d.slice(off1,off1+64))); const prices=[];
    for(let i=0;i<pc;i++) prices.push(BigInt('0x'+d.slice(off1+64+i*64,off1+128+i*64)).toString());
    return toks.map((t,i)=>({token:t,price:prices[i]||'0'}));
  } catch { return []; }
}

async function getAllowedToks() {
  try {
    const s=sel('getAllowedTokens()'); const r=await ethCall(FACTORY,'0x'+s);
    const d=r.slice(2); if(d.length<192) return [];
    const off0=Number(BigInt('0x'+d.slice(0,64)))*2; const off1=Number(BigInt('0x'+d.slice(64,128)))*2; const off2=Number(BigInt('0x'+d.slice(128,192)))*2;
    const ac=Number(BigInt('0x'+d.slice(off0,off0+64))); const addrs=[];
    for(let i=0;i<ac;i++) addrs.push('0x'+d.slice(off0+64+i*64+24,off0+64+(i+1)*64));
    const sc=Number(BigInt('0x'+d.slice(off1,off1+64))); const symStart=off1+64; const syms=[];
    for(let i=0;i<sc;i++){const so=Number(BigInt('0x'+d.slice(symStart+i*64,symStart+(i+1)*64)))*2;const absOff=symStart+so;const sl=Number(BigInt('0x'+d.slice(absOff,absOff+64)));syms.push(hexStr(d.slice(absOff+64,absOff+64+sl*2)));}
    const dc=Number(BigInt('0x'+d.slice(off2,off2+64))); const decs=[];
    for(let i=0;i<dc;i++) decs.push(Number(BigInt('0x'+d.slice(off2+64+i*64,off2+128+i*64))));
    const tokens = addrs.map((a,i)=>({address:a,symbol:syms[i]||'ERC20',decimals:decs[i]||18}));

    // Fix garbled symbols by querying token contracts directly
    for (const tok of tokens) {
      if (!tok.symbol || tok.symbol === 'ERC20' || /[^\x20-\x7E]/.test(tok.symbol)) {
        try {
          const symSel=sel('symbol()'); const symR=await ethCall(tok.address,'0x'+symSel);
          const sd=symR.slice(2); const sOff=Number(BigInt('0x'+sd.slice(0,64)))*2;
          const sLen=Number(BigInt('0x'+sd.slice(sOff,sOff+64)));
          tok.symbol=hexStr(sd.slice(sOff+64,sOff+64+sLen*2))||'ERC20';
        } catch{}
      }
      if (tok.decimals===18) {
        try { const dSel=sel('decimals()'); const dR=await ethCall(tok.address,'0x'+dSel); tok.decimals=Number(BigInt(dR)); } catch{}
      }
    }
    return tokens;
  } catch { return []; }
}

async function erc20Allow(token,owner,spender) {
  const s=sel('allowance(address,address)'); const data='0x'+s+padAddr(owner)+padAddr(spender);
  const r=await ethCall(token,data); return BigInt(r);
}

async function rpc_call(method, params) {
  const r = await fetch(RPC, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({jsonrpc:'2.0',id:Date.now(),method,params}) });
  const d = await r.json(); if(d.error) throw new Error(d.error.message); return d.result;
}
async function ethCall(to, data) { return rpc_call('eth_call', [{to, data}, 'latest']); }

// ═══════════════════════════════════════════════════════════════
//  CONTENT SOURCE DETECTION (YouTube / IPFS / Direct URL)
// ═══════════════════════════════════════════════════════════════

function detectContentSource(contentRef) {
  if (!contentRef) return { type: 'unknown', value: '' };
  const trimmed = contentRef.trim();

  // IPFS protocol URL
  if (trimmed.startsWith('ipfs://')) return { type: 'ipfs', value: trimmed };

  // IPFS gateway URL
  if (trimmed.includes('/ipfs/') || trimmed.includes('/ipns/')) return { type: 'ipfs', value: trimmed };

  // Direct video URL (with video extension)
  const videoExts = /\.(mp4|webm|ogg|mov|m3u8|mkv)(\?.*)?$/i;
  if ((trimmed.startsWith('http://') || trimmed.startsWith('https://')) && videoExts.test(trimmed)) {
    return { type: 'direct', value: trimmed };
  }

  // HTTP(S) URL — check if it's YouTube, otherwise treat as direct
  if (trimmed.startsWith('http://') || trimmed.startsWith('https://')) {
    const ytMatch = trimmed.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/)([a-zA-Z0-9_-]{11})/);
    if (ytMatch) return { type: 'youtube', value: ytMatch[1] };
    return { type: 'direct', value: trimmed };
  }

  // Bare IPFS CID
  if (/^(Qm[a-zA-Z0-9]{44,}|bafy[a-zA-Z0-9]{50,})$/.test(trimmed)) {
    return { type: 'ipfs', value: 'ipfs://' + trimmed };
  }

  // YouTube video ID (11 chars)
  if (/^[a-zA-Z0-9_-]{11}$/.test(trimmed)) return { type: 'youtube', value: trimmed };

  // Fallback — assume YouTube ID for backward compatibility
  return { type: 'youtube', value: trimmed };
}

function resolveVideoUrl(source) {
  if (source.type === 'youtube') return null;
  if (source.type === 'ipfs') {
    const val = source.value;
    if (val.startsWith('http://') || val.startsWith('https://')) return val;
    if (val.startsWith('ipfs://')) return `${IPFS_GATEWAY}/ipfs/${val.replace('ipfs://', '')}`;
    return `${IPFS_GATEWAY}/ipfs/${val}`;
  }
  if (source.type === 'direct') return source.value;
  return null;
}

function getThumbnailUrl(source) {
  if (source.type === 'youtube') return `https://img.youtube.com/vi/${source.value}/hqdefault.jpg`;
  return null;
}

// ── Init ──
(async function init() {
  if (!VAULT || !RESOURCE) {
    document.getElementById('errorScreen').style.display = 'block';
    return;
  }

  document.getElementById('mainCard').style.display = 'block';

  try {
    // getResource(string) → (price, lifetime, active, exists, contentType, contentRef, totalPayments)
    const s = sel('getResource(string)');
    const data = '0x' + s + padUint(32) + encStr(RESOURCE);
    const result = await ethCall(VAULT, data);
    const d = result.slice(2);

    const price = BigInt('0x' + d.slice(0, 64)).toString();
    const lifetime = BigInt('0x' + d.slice(64, 128)) === 1n;
    const active = BigInt('0x' + d.slice(128, 192)) === 1n;
    const exists = BigInt('0x' + d.slice(192, 256)) === 1n;

    // Decode contentType (offset at word 4)
    const typeOff = Number(BigInt('0x' + d.slice(256, 320))) * 2;
    const typeLen = Number(BigInt('0x' + d.slice(typeOff, typeOff + 64)));
    const contentType = hexStr(d.slice(typeOff + 64, typeOff + 64 + typeLen * 2));

    // Decode contentRef (offset at word 5)
    const refOff = Number(BigInt('0x' + d.slice(320, 384))) * 2;
    const refLen = Number(BigInt('0x' + d.slice(refOff, refOff + 64)));
    const contentRef = hexStr(d.slice(refOff + 64, refOff + 64 + refLen * 2));

    const totalPayments = Number(BigInt('0x' + d.slice(384, 448)));

    if (!exists) {
      document.getElementById('resTitle').textContent = 'Resource Not Found';
      document.getElementById('resDesc').textContent = `"${RESOURCE}" does not exist in this vault.`;
      document.getElementById('actionBtn').style.display = 'none';
      return;
    }

    resourceConfig = { price, lifetime, active, contentType, contentRef, totalPayments };

    // Detect V2 and load token options
    vaultVersion = await getVaultVer();
    if (vaultVersion >= 2) {
      const accepted = await getAcceptedToks(RESOURCE);
      if (accepted.length > 0) {
        const allowed = await getAllowedToks();
        acceptedTokens = accepted.map(a => {
          const info = allowed.find(t => t.address.toLowerCase() === a.token.toLowerCase());
          return { token: a.token, price: a.price, symbol: info?.symbol || 'ERC20', decimals: info?.decimals || 18 };
        }).filter(t => BigInt(t.price) > 0n);
      }
    }

    // Show token selector if options available
    if (acceptedTokens.length > 0) {
      const row = document.getElementById('tokenSelectorRow');
      row.style.display = 'block';
      let btnsHtml = `<button class="chip" data-pay="native" onclick="selectPay('native')" style="cursor:pointer;font-weight:bold;border-color:rgba(50,114,232,0.2);background:var(--blue-glow);display:inline-flex;align-items:center;gap:4px;">
        <img src="${APTM_ICON}" alt="" style="width:14px;height:14px;border-radius:50%;"><strong>${fromWei(price)} APTM</strong>
      </button>`;
      for (const t of acceptedTokens) {
        const meta = getTokenMeta(t.symbol);
        const iconHtml = meta && meta.icon ? `<img src="${meta.icon}" alt="" style="width:14px;height:14px;border-radius:50%;vertical-align:-2px;margin-right:4px;">` : '';
        btnsHtml += `<button class="chip" data-pay="${t.token}" onclick="selectPay('${t.token}')" style="cursor:pointer;display:inline-flex;align-items:center;gap:4px;">
          ${iconHtml}<strong>${fmtTokAmt(t.price, t.decimals)} ${t.symbol}</strong>
        </button>`;
      }
      document.getElementById('tokenButtons').innerHTML = btnsHtml;
    }

    // Update UI
    document.getElementById('resTitle').textContent = RESOURCE;
    document.getElementById('resDesc').textContent = active
      ? `Pay ${fromWei(price)} APTM to unlock this ${contentType}.`
      : 'This resource is currently paused by the creator.';
    document.getElementById('priceDisplay').innerHTML = fromWei(price) + '<span class="cur"><img src="' + APTM_ICON + '" alt="" style="width:13px;height:13px;border-radius:50%;vertical-align:-2px;margin-right:3px;">APTM</span>';

    let chips = '<div class="chip"><strong>Protocol</strong> HTTP 402</div>';
    chips += '<div class="chip"><strong>Verified</strong> On-Chain</div>';
    chips += '<div class="chip"><strong>Finality</strong> ~1s</div>';
    if (lifetime) chips += '<div class="chip lifetime"><strong>♾ Lifetime</strong></div>';
    document.getElementById('chipRow').innerHTML = chips;

    if (!active) {
      document.getElementById('actionBtn').disabled = true;
      document.getElementById('actionBtn').textContent = 'Resource Paused';
    }

    // Show thumbnail/preview (supports all content types)
    if (contentType === 'video' && contentRef) {
      const source = detectContentSource(contentRef);
      const thumbUrl = getThumbnailUrl(source);

      if (thumbUrl) {
        // YouTube — show thumbnail
        const img = document.createElement('img');
        img.src = thumbUrl;
        img.style.cssText = 'width:100%;height:100%;object-fit:cover;position:absolute;inset:0;z-index:0;';
        document.getElementById('videoArea').insertBefore(img, document.getElementById('lockOverlay'));
      } else {
        // IPFS/Direct — show a styled video icon placeholder
        const placeholder = document.createElement('div');
        placeholder.style.cssText = 'width:100%;height:100%;position:absolute;inset:0;z-index:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;background:linear-gradient(135deg,#0a0b0d,#141620);';
        const sourceLabel = source.type === 'ipfs' ? 'IPFS Video' : 'Direct Video';
        placeholder.innerHTML = `
          <svg viewBox="0 0 24 24" style="width:48px;height:48px;stroke:rgba(255,255,255,0.15);fill:none;stroke-width:1.5;">
            <polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/>
          </svg>
          <span style="font-size:11px;color:rgba(255,255,255,0.2);font-family:var(--mono);">${sourceLabel}</span>
        `;
        document.getElementById('videoArea').insertBefore(placeholder, document.getElementById('lockOverlay'));
      }
    } else if (['article','file','api'].includes(contentType)) {
      // Non-video type — show type-specific preview
      const typeInfo = {
        article: { icon: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>', label: 'Gated Article', color: '#8b5cf6' },
        file: { icon: '<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>', label: 'Paid Download', color: '#eab308' },
        api: { icon: '<polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>', label: 'API Access', color: '#06b6d4' },
      };
      const ti = typeInfo[contentType];
      const placeholder = document.createElement('div');
      placeholder.style.cssText = 'width:100%;height:100%;position:absolute;inset:0;z-index:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;background:linear-gradient(135deg,#0a0b0d,#141620);';
      placeholder.innerHTML = `
        <svg viewBox="0 0 24 24" style="width:48px;height:48px;stroke:${ti.color};fill:none;stroke-width:1.5;opacity:0.25;stroke-linecap:round;stroke-linejoin:round;">
          ${ti.icon}
        </svg>
        <span style="font-size:11px;color:rgba(255,255,255,0.2);font-family:var(--mono);">${ti.label}</span>
      `;
      document.getElementById('videoArea').insertBefore(placeholder, document.getElementById('lockOverlay'));
    }

    // Auto-reconnect
    if (active && window.ethereum) {
      try {
        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        if (accounts.length > 0) {
          const chainId = await window.ethereum.request({ method: 'eth_chainId' });
          if (chainId === CHAIN_HEX) {
            userAddress = accounts[0];

            if (lifetime) {
              const hs = sel('hasAccess(string,address)');
              const hd = '0x' + hs + padUint(64) + padAddr(userAddress) + encStr(RESOURCE);
              const hr = await ethCall(VAULT, hd);
              if (BigInt(hr) === 1n) {
                unlockContent();
                return;
              }
            }

            state = 'connected';
            const priceAptm = fromWei(price);
            const btn = document.getElementById('actionBtn');
            btn.disabled = false;
            btn.innerHTML = `<svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg> Pay ${priceAptm} APTM`;
            showStatus('info', 'Wallet connected. Estimating total cost...');
            estimatePayGas().then(() => {
              showStatus('info', 'Wallet connected. Click to pay and unlock.');
            }).catch(() => {
              showStatus('info', 'Wallet connected. Click to pay and unlock.');
            });
          }
        }
      } catch { /* silent — user clicks connect manually */ }
    }

  } catch (err) {
    document.getElementById('resTitle').textContent = 'Error';
    document.getElementById('resDesc').textContent = 'Failed to load resource: ' + err.message;
  }
})();

// ── Token Payment Selection ──
function selectPay(method) {
  selectedPayment = method;
  document.querySelectorAll('#tokenButtons .chip').forEach(b => {
    const isSelected = b.dataset.pay === method;
    b.style.fontWeight = isSelected ? 'bold' : 'normal';
    b.style.borderColor = isSelected ? 'rgba(50,114,232,0.2)' : '';
    b.style.background = isSelected ? 'var(--blue-glow)' : '';
  });
  // Update pay button label
  if (state === 'connected') {
    const btn = document.getElementById('actionBtn');
    if (method === 'native') {
      btn.innerHTML = `<svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg> Pay ${fromWei(resourceConfig.price)} <img src="${APTM_ICON}" alt="" style="width:13px;height:13px;border-radius:50%;vertical-align:-2px;margin:0 2px;">APTM`;
    } else {
      const tok = acceptedTokens.find(t => t.token === method);
      if (tok) {
        const meta = getTokenMeta(tok.symbol);
        const icon = meta && meta.icon ? `<img src="${meta.icon}" alt="" style="width:13px;height:13px;border-radius:50%;vertical-align:-2px;margin:0 2px;">` : '';
        btn.innerHTML = `<svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg> Pay ${fmtTokAmt(tok.price, tok.decimals)} ${icon}${tok.symbol}`;
      }
    }
  }
}

// ── Actions ──
async function handleAction() {
  if (state === 'disconnected') return connectWallet();
  if (state === 'connected') return pay();
}

async function connectWallet() {
  if (!window.ethereum) { showStatus('error', 'No wallet detected. Install MetaMask.'); return; }
  const btn = document.getElementById('actionBtn');
  btn.disabled = true; btn.innerHTML = '<div class="spinner"></div> Connecting...';

  try {
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    userAddress = accounts[0];

    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
    if (chainId !== CHAIN_HEX) {
      try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CHAIN_HEX }] }); }
      catch (e) {
        if (e.code === 4902) await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: CHAIN_HEX, chainName: 'Apertum', nativeCurrency: { name:'APTM',symbol:'APTM',decimals:18 }, rpcUrls: [RPC], blockExplorerUrls: [EXPLORER] }] });
        else throw e;
      }
    }

    // Check lifetime access
    if (resourceConfig.lifetime) {
      showStatus('info', 'Checking existing access...');
      const s = sel('hasAccess(string,address)');
      const data = '0x' + s + padUint(64) + padAddr(userAddress) + encStr(RESOURCE);
      const result = await ethCall(VAULT, data);
      if (BigInt(result) === 1n) {
        showStatus('success', '♻️ Lifetime access confirmed — already paid!');
        unlockContent();
        return;
      }
    }

    state = 'connected';
    const priceAptm = fromWei(resourceConfig.price);
    btn.disabled = false;
    btn.innerHTML = `<svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg> Pay ${priceAptm} APTM`;
    showStatus('info', 'Wallet connected. Estimating total cost...');

    estimatePayGas().then(() => {
      showStatus('info', 'Wallet connected. Click to pay and unlock.');
    }).catch(() => {
      showStatus('info', 'Wallet connected. Click to pay and unlock.');
    });

  } catch (err) {
    showStatus('error', 'Connection failed: ' + err.message);
    btn.disabled = false;
    btn.innerHTML = 'Connect Wallet';
  }
}

async function pay() {
  const btn = document.getElementById('actionBtn');
  btn.disabled = true; btn.innerHTML = '<div class="spinner"></div> Confirm in wallet...';
  showStatus('pending', 'Confirm the transaction in your wallet...');

  try {
    const nonceBytes = new Uint8Array(32);
    crypto.getRandomValues(nonceBytes);
    const nonce = '0x' + Array.from(nonceBytes).map(b => b.toString(16).padStart(2, '0')).join('');

    if (selectedPayment !== 'native' && vaultVersion >= 2) {
      // ── ERC-20 Token Payment ──
      const tok = acceptedTokens.find(t => t.token === selectedPayment);
      if (!tok) throw new Error('Token not found');
      const tokenPrice = BigInt(tok.price);

      // Check allowance
      btn.innerHTML = '<div class="spinner"></div> Checking allowance...';
      showStatus('info', `Checking ${tok.symbol} allowance...`);
      const currentAllowance = await erc20Allow(tok.token, userAddress, VAULT);

      if (currentAllowance < tokenPrice) {
        btn.innerHTML = '<div class="spinner"></div> Approve in wallet...';
        showStatus('pending', `Approve ${tok.symbol} spending — confirm in wallet...`);
        const approveSel = sel('approve(address,uint256)');
        const approveData = '0x' + approveSel + padAddr(VAULT) + padUint(tokenPrice);
        const approveTx = await window.ethereum.request({
          method: 'eth_sendTransaction',
          params: [{ from: userAddress, to: tok.token, data: approveData }],
        });
        showStatus('pending', 'Approval sent, confirming...');
        btn.innerHTML = '<div class="spinner"></div> Approving...';
        for (let i = 0; i < 30; i++) {
          await new Promise(r => setTimeout(r, 1500));
          const receipt = await rpc_call('eth_getTransactionReceipt', [approveTx]);
          if (receipt) { if (receipt.status !== '0x1') throw new Error('Approval failed'); break; }
          if (i === 29) throw new Error('Approval timeout');
        }
      }

      // payWithToken(string, address, bytes32)
      btn.innerHTML = '<div class="spinner"></div> Confirm payment...';
      showStatus('pending', `Pay with ${tok.symbol} — confirm in wallet...`);
      const s = sel('payWithToken(string,address,bytes32)');
      const headSize = 3 * 32;
      const resEncoded = encStr(RESOURCE);
      const data = '0x' + s + padUint(headSize) + padAddr(tok.token) + nonce.replace('0x', '') + resEncoded;

      const txHash = await window.ethereum.request({
        method: 'eth_sendTransaction',
        params: [{ from: userAddress, to: VAULT, data }],
      });

      showStatus('pending', 'Transaction sent! Confirming on Apertum...');
      document.getElementById('txLink').classList.add('show');
      document.getElementById('txLink').innerHTML = `Tx: <a href="${EXPLORER}/tx/${txHash}" target="_blank">${txHash}</a>`;

      for (let i = 0; i < 30; i++) {
        await new Promise(r => setTimeout(r, 1500));
        const receipt = await rpc_call('eth_getTransactionReceipt', [txHash]);
        if (receipt) { if (receipt.status !== '0x1') throw new Error('Transaction reverted'); break; }
        if (i === 29) throw new Error('Confirmation timeout');
      }

      showStatus('success', resourceConfig.lifetime
        ? `✓ Lifetime access granted (paid with ${tok.symbol})!`
        : `✓ Payment verified with ${tok.symbol}. Content unlocked!`);
      unlockContent();

    } else {
      // ── Native APTM Payment (existing flow) ──
      const s = sel('payForAccess(string,bytes32)');
      const data = '0x' + s + padUint(64) + nonce.replace('0x', '') + encStr(RESOURCE);

      const txHash = await window.ethereum.request({
        method: 'eth_sendTransaction',
        params: [{ from: userAddress, to: VAULT, data, value: '0x' + BigInt(resourceConfig.price).toString(16) }],
      });

      showStatus('pending', 'Transaction sent! Confirming on Apertum...');
      document.getElementById('txLink').classList.add('show');
      document.getElementById('txLink').innerHTML = `Tx: <a href="${EXPLORER}/tx/${txHash}" target="_blank">${txHash}</a>`;

      for (let i = 0; i < 30; i++) {
        await new Promise(r => setTimeout(r, 1500));
        const receipt = await rpc_call('eth_getTransactionReceipt', [txHash]);
        if (receipt) { if (receipt.status !== '0x1') throw new Error('Transaction reverted'); break; }
        if (i === 29) throw new Error('Confirmation timeout');
      }

      showStatus('success', resourceConfig.lifetime
        ? '✓ Lifetime access granted! This content is yours forever.'
        : '✓ Payment verified. Content unlocked!');
      unlockContent();
    }

  } catch (err) {
    showStatus('error', err.code === 4001 ? 'Transaction rejected.' : 'Failed: ' + err.message);
    btn.disabled = false;
    if (selectedPayment === 'native') {
      btn.innerHTML = `Pay ${fromWei(resourceConfig.price)} APTM`;
    } else {
      const tok = acceptedTokens.find(t => t.token === selectedPayment);
      btn.innerHTML = tok ? `Pay ${fmtTokAmt(tok.price, tok.decimals)} ${tok.symbol}` : 'Pay';
    }
  }
}

// ── Gas Estimation ──
async function estimatePayGas() {
  try {
    const nonceBytes = new Uint8Array(32);
    crypto.getRandomValues(nonceBytes);
    const nonce = '0x' + Array.from(nonceBytes).map(b => b.toString(16).padStart(2, '0')).join('');

    const s = sel('payForAccess(string,bytes32)');
    const data = '0x' + s + padUint(64) + nonce.replace('0x', '') + encStr(RESOURCE);

    const [gasEstimate, gasPrice] = await Promise.all([
      rpc_call('eth_estimateGas', [{ from: userAddress, to: VAULT, data, value: '0x' + BigInt(resourceConfig.price).toString(16) }]),
      rpc_call('eth_gasPrice', []),
    ]);

    const gasUnits = BigInt(gasEstimate);
    const gasPriceWei = BigInt(gasPrice);
    const gasCostWei = gasUnits * gasPriceWei;
    const totalWei = BigInt(resourceConfig.price) + gasCostWei;

    document.getElementById('gasDisplay').innerHTML = `~${fromWei(gasCostWei.toString())}<span class="cur">APTM</span>`;
    document.getElementById('totalDisplay').innerHTML = `~${fromWei(totalWei.toString())}<span class="cur" style="color:var(--green);">APTM</span>`;
    document.getElementById('gasRow').style.display = 'flex';
    document.getElementById('totalRow').style.display = 'flex';
  } catch (err) {
    // Silently fail — price row is still visible
  }
}

// ═══════════════════════════════════════════════════════════════
//  UNLOCK CONTENT — routes to YouTube or HTML5 player
// ═══════════════════════════════════════════════════════════════

function unlockContent() {
  state = 'unlocked';
  document.getElementById('lockOverlay').classList.add('hidden');

  const cType = resourceConfig.contentType;

  if (cType === 'video' || (!['article','file','api'].includes(cType))) {
    // ── Video renderer (existing) ──
    if (resourceConfig.contentRef) {
      const source = detectContentSource(resourceConfig.contentRef);
      if (source.type === 'youtube') {
        buildYouTubePlayer(source.value);
      } else {
        const videoUrl = resolveVideoUrl(source);
        if (videoUrl) buildHTML5Player(videoUrl);
      }
    }
    // Switch to minimal mode
    document.querySelector('.container').classList.add('unlocked');
    document.querySelector('.body').classList.add('minimal');
    document.getElementById('actionBtn').style.display = 'none';
    document.querySelector('.header').style.display = 'none';
    document.querySelector('.footer').style.display = 'none';

  } else if (cType === 'article') {
    // ── Article renderer ──
    const area = document.getElementById('videoArea');
    area.style.aspectRatio = 'auto';
    area.style.minHeight = '300px';
    area.style.maxHeight = '80vh';
    area.style.overflow = 'auto';
    area.style.background = 'var(--bg-card)';
    area.style.padding = '32px';

    area.innerHTML = '<div style="text-align:center;padding:20px;"><div class="spinner" style="margin:0 auto 8px;"></div><div style="font-size:12px;color:var(--text-dim);">Loading article...</div></div>';

    let url = resourceConfig.contentRef;
    if (url.startsWith('ipfs://')) url = 'https://ipfs.io/ipfs/' + url.replace('ipfs://', '');
    else if (/^(Qm|bafy)/.test(url)) url = 'https://ipfs.io/ipfs/' + url;

    fetch(url).then(r => r.text()).then(text => {
      let html = text
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/^### (.+)$/gm, '<h3 style="font-size:16px;font-weight:600;color:var(--text-bright);margin:16px 0 8px;">$1</h3>')
        .replace(/^## (.+)$/gm, '<h2 style="font-size:18px;font-weight:600;color:var(--text-bright);margin:20px 0 10px;">$1</h2>')
        .replace(/^# (.+)$/gm, '<h1 style="font-size:22px;font-weight:700;color:var(--text-bright);margin:24px 0 12px;">$1</h1>')
        .replace(/\*\*(.+?)\*\*/g, '<strong style="color:var(--text-bright);">$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/`(.+?)`/g, '<code style="background:var(--bg);padding:2px 6px;border-radius:4px;font-family:var(--mono);font-size:12px;">$1</code>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener" style="color:var(--blue-light);">$1</a>')
        .replace(/\n\n/g, '</p><p style="margin-bottom:12px;">')
        .replace(/\n/g, '<br>');
      if (text.trim().match(/^(<html|<!doctype)/i)) html = text;
      area.innerHTML = '<div style="font-size:14px;line-height:1.8;color:var(--text);"><p style="margin-bottom:12px;">' + html + '</p></div>';
    }).catch(err => {
      area.innerHTML = `<div style="text-align:center;padding:20px;"><div style="color:var(--red);font-size:13px;margin-bottom:6px;">Failed to load article</div><div style="font-size:11px;color:var(--text-dim);">${err.message}</div><a href="${url}" target="_blank" style="display:inline-block;margin-top:10px;color:var(--blue-light);font-size:12px;">Open directly</a></div>`;
    });

    document.getElementById('actionBtn').style.display = 'none';
    document.querySelector('.header').style.display = 'none';
    document.querySelector('.footer').style.display = 'none';

  } else if (cType === 'file') {
    // ── File download renderer ──
    const area = document.getElementById('videoArea');
    area.style.aspectRatio = 'auto';
    area.style.minHeight = '200px';
    area.style.background = 'var(--bg-card)';
    area.style.display = 'flex';
    area.style.alignItems = 'center';
    area.style.justifyContent = 'center';
    area.style.padding = '40px';

    let url = resourceConfig.contentRef;
    if (url.startsWith('ipfs://')) url = 'https://ipfs.io/ipfs/' + url.replace('ipfs://', '');
    else if (/^(Qm|bafy)/.test(url)) url = 'https://ipfs.io/ipfs/' + url;

    let fileName = 'Download File';
    try { fileName = url.split('/').pop().split('?')[0] || 'Download File'; } catch {}

    area.innerHTML = `
      <div style="text-align:center;">
        <svg viewBox="0 0 24 24" style="width:56px;height:56px;stroke:var(--green);fill:none;stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round;margin-bottom:16px;">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        <div style="font-size:16px;font-weight:600;color:var(--text-bright);margin-bottom:4px;">${fileName}</div>
        <div style="font-size:12px;color:var(--text-dim);margin-bottom:20px;">Payment verified — your file is ready.</div>
        <a href="${url}" target="_blank" download
          style="display:inline-flex;align-items:center;gap:8px;padding:14px 28px;border-radius:10px;background:var(--green);color:#000;font-size:14px;font-weight:600;text-decoration:none;">
          <svg viewBox="0 0 24 24" style="width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Download
        </a>
      </div>`;

    document.getElementById('actionBtn').style.display = 'none';

  } else if (cType === 'api') {
    // ── API access renderer ──
    const area = document.getElementById('videoArea');
    area.style.aspectRatio = 'auto';
    area.style.minHeight = '260px';
    area.style.background = 'var(--bg-card)';
    area.style.padding = '32px';

    const tokenData = (userAddress || '0x0') + ':' + RESOURCE + ':' + Date.now();
    const token = 'a402_' + keccak256(tokenData).slice(0, 48);

    area.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px;">
        <svg viewBox="0 0 24 24" style="width:32px;height:32px;stroke:#06b6d4;fill:none;stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round;">
          <polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>
        </svg>
        <div>
          <div style="font-size:16px;font-weight:600;color:var(--text-bright);">API Access Granted</div>
          <div style="font-size:12px;color:var(--text-dim);">Include the token below in your API requests.</div>
        </div>
      </div>
      <div style="margin-bottom:16px;">
        <div style="font-family:var(--mono);font-size:10px;color:var(--text-dim);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.8px;">Endpoint</div>
        <div style="padding:12px 16px;background:var(--bg);border:1px solid var(--border);border-radius:8px;font-family:var(--mono);font-size:13px;color:var(--blue-light);word-break:break-all;">${resourceConfig.contentRef}</div>
      </div>
      <div style="margin-bottom:16px;">
        <div style="font-family:var(--mono);font-size:10px;color:var(--text-dim);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.8px;">Access Token</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <div style="flex:1;padding:12px 16px;background:var(--bg);border:1px solid var(--border);border-radius:8px;font-family:var(--mono);font-size:12px;color:var(--green);word-break:break-all;" id="apiTokenDisplay">${token}</div>
          <button onclick="navigator.clipboard.writeText('${token}');this.textContent='Copied!';this.style.color='var(--green)';this.style.borderColor='var(--green)';setTimeout(()=>{this.textContent='Copy';this.style.color='';this.style.borderColor=''},2000)"
            style="padding:10px 16px;border-radius:6px;border:1px solid var(--border);background:var(--bg);font-family:var(--mono);font-size:11px;color:var(--text-dim);cursor:pointer;white-space:nowrap;">Copy</button>
        </div>
      </div>
      <div style="padding:12px 16px;background:rgba(6,182,212,0.06);border:1px solid rgba(6,182,212,0.1);border-radius:8px;font-family:var(--mono);font-size:12px;color:var(--text-dim);line-height:1.6;">
        <strong style="color:var(--text);">Usage:</strong> curl -H "Authorization: Bearer ${token}" ${resourceConfig.contentRef}
      </div>`;

    document.getElementById('actionBtn').style.display = 'none';
  }

  document.getElementById('minimalLabel').textContent =
    resourceConfig.lifetime ? 'Lifetime Access' : 'Access Granted';
}

// ═══════════════════════════════════════════════════════════════
//  YOUTUBE PLAYER (existing)
// ═══════════════════════════════════════════════════════════════

let ytPlayer = null;
let seekInterval = null;
let isSeeking = false;

function buildYouTubePlayer(videoId) {
  const area = document.getElementById('videoArea');

  const wrap = document.createElement('div');
  wrap.className = 'player-wrap paused';
  wrap.id = 'playerWrap';
  wrap.addEventListener('contextmenu', e => e.preventDefault());
  wrap.innerHTML = `
    <div id="ytContainer"></div>
    <div class="player-click-zone" id="clickZone"></div>
    <div class="center-play" id="centerPlay">
      <svg viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
    </div>
    <div class="player-controls force-show" id="playerControls">
      <div class="seek-row">
        <input type="range" class="seek-bar" id="seekBar" min="0" max="1000" value="0">
      </div>
      <div class="ctrl-row">
        <button class="ctrl-btn" id="playPauseBtn" title="Play/Pause">
          <svg viewBox="0 0 24 24" id="playIcon"><polygon points="5,3 19,12 5,21"/></svg>
          <svg viewBox="0 0 24 24" id="pauseIcon" style="display:none;"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
        </button>
        <div class="vol-group">
          <button class="ctrl-btn small" id="volBtn" title="Mute/Unmute">
            <svg viewBox="0 0 24 24" id="volOnIcon"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07" fill="none" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/></svg>
            <svg viewBox="0 0 24 24" id="volOffIcon" style="display:none;"><path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/><line x1="17" y1="9" x2="23" y2="15" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/></svg>
          </button>
          <input type="range" class="vol-bar" id="volBar" min="0" max="100" value="80">
        </div>
        <span class="time-display" id="timeDisplay">0:00 / 0:00</span>
        <div class="ctrl-spacer"></div>
        <button class="ctrl-btn small" id="fsBtn" title="Fullscreen">
          <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
        </button>
      </div>
    </div>
  `;
  area.insertBefore(wrap, document.getElementById('lockOverlay'));

  const tag = document.createElement('script');
  tag.src = 'https://www.youtube.com/iframe_api';
  document.head.appendChild(tag);

  window.onYouTubeIframeAPIReady = function() {
    ytPlayer = new YT.Player('ytContainer', {
      videoId: videoId,
      width: '100%',
      height: '100%',
      playerVars: {
        autoplay: 1, controls: 0, rel: 0, modestbranding: 1,
        showinfo: 0, iv_load_policy: 3, disablekb: 1, playsinline: 1,
      },
      events: { onReady: onPlayerReady, onStateChange: onPlayerStateChange },
    });
  };
}

function onPlayerReady(e) {
  const player = e.target;
  player.setVolume(80);

  setTimeout(() => {
    document.getElementById('playerControls').classList.remove('force-show');
  }, 2000);

  seekInterval = setInterval(updateSeek, 250);

  document.getElementById('clickZone').addEventListener('click', togglePlayPause);
  document.getElementById('centerPlay').addEventListener('click', togglePlayPause);
  document.getElementById('playPauseBtn').addEventListener('click', togglePlayPause);

  const seekBar = document.getElementById('seekBar');
  seekBar.addEventListener('input', () => {
    isSeeking = true;
    const duration = ytPlayer.getDuration();
    const time = (seekBar.value / 1000) * duration;
    document.getElementById('timeDisplay').textContent = fmtTime(time) + ' / ' + fmtTime(duration);
  });
  seekBar.addEventListener('change', () => {
    const duration = ytPlayer.getDuration();
    ytPlayer.seekTo((seekBar.value / 1000) * duration, true);
    isSeeking = false;
  });

  document.getElementById('volBar').addEventListener('input', (e) => {
    const vol = parseInt(e.target.value);
    ytPlayer.setVolume(vol);
    ytPlayer.unMute();
    updateVolIcon(vol);
  });
  document.getElementById('volBtn').addEventListener('click', () => {
    if (ytPlayer.isMuted()) { ytPlayer.unMute(); updateVolIcon(ytPlayer.getVolume()); }
    else { ytPlayer.mute(); updateVolIcon(0); }
  });

  document.getElementById('fsBtn').addEventListener('click', () => {
    const wrap = document.getElementById('playerWrap');
    if (document.fullscreenElement) document.exitFullscreen();
    else wrap.requestFullscreen().catch(() => {});
  });
}

function onPlayerStateChange(e) {
  const wrap = document.getElementById('playerWrap');
  if (e.data === YT.PlayerState.PLAYING) {
    wrap.classList.remove('paused');
    document.getElementById('playIcon').style.display = 'none';
    document.getElementById('pauseIcon').style.display = 'block';
  } else if (e.data === YT.PlayerState.PAUSED || e.data === YT.PlayerState.ENDED) {
    wrap.classList.add('paused');
    document.getElementById('playIcon').style.display = 'block';
    document.getElementById('pauseIcon').style.display = 'none';
  }
}

function togglePlayPause() {
  if (!ytPlayer) return;
  const s = ytPlayer.getPlayerState();
  if (s === YT.PlayerState.PLAYING) ytPlayer.pauseVideo();
  else ytPlayer.playVideo();
}

function updateSeek() {
  if (!ytPlayer || isSeeking || typeof ytPlayer.getDuration !== 'function') return;
  const dur = ytPlayer.getDuration();
  const cur = ytPlayer.getCurrentTime();
  if (dur > 0) {
    document.getElementById('seekBar').value = (cur / dur) * 1000;
    document.getElementById('timeDisplay').textContent = fmtTime(cur) + ' / ' + fmtTime(dur);
    const pct = (cur / dur) * 100;
    document.getElementById('seekBar').style.background = `linear-gradient(to right, var(--blue-light) ${pct}%, rgba(255,255,255,0.15) ${pct}%)`;
  }
}

function updateVolIcon(vol) {
  document.getElementById('volOnIcon').style.display = vol > 0 ? 'block' : 'none';
  document.getElementById('volOffIcon').style.display = vol > 0 ? 'none' : 'block';
}

function fmtTime(s) {
  const m = Math.floor(s / 60);
  const sec = Math.floor(s % 60);
  return m + ':' + sec.toString().padStart(2, '0');
}

// ═══════════════════════════════════════════════════════════════
//  HTML5 VIDEO PLAYER (IPFS / Direct URL)
// ═══════════════════════════════════════════════════════════════

let html5Player = null;

function buildHTML5Player(videoUrl) {
  const area = document.getElementById('videoArea');

  const wrap = document.createElement('div');
  wrap.className = 'player-wrap';
  wrap.id = 'playerWrap';
  wrap.innerHTML = `
    <video id="html5Video"
      src="${videoUrl}"
      autoplay
      controls
      playsinline
      controlsList="nodownload noplaybackrate"
      disablepictureinpicture
      oncontextmenu="return false;"
      draggable="false"
      style="width:100%; height:100%; background:#000; object-fit:contain;">
      Your browser does not support the video tag.
    </video>
    <div class="video-error" id="videoError" style="display:none;">
      <div style="text-align:center; color:var(--text-dim); padding:24px;">
        <svg viewBox="0 0 24 24" style="width:48px;height:48px;stroke:var(--text-muted);fill:none;stroke-width:1.5;margin-bottom:12px;">
          <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <div style="font-size:14px;color:var(--text-bright);margin-bottom:6px;">Video failed to load</div>
        <div style="font-size:12px;margin-bottom:12px;">The source may be temporarily unavailable or the format may not be supported by your browser.</div>
        <span style="color:var(--text-dim);font-size:12px;">
          Try refreshing the page or check your connection.
        </span>
      </div>
    </div>
  `;
  area.insertBefore(wrap, document.getElementById('lockOverlay'));

  html5Player = document.getElementById('html5Video');

  // Download protection: block right-click on player and video area
  html5Player.addEventListener('contextmenu', e => e.preventDefault());
  wrap.addEventListener('contextmenu', e => e.preventDefault());

  html5Player.addEventListener('error', function() {
    document.getElementById('videoError').style.display = 'flex';
    html5Player.style.display = 'none';
  });
}

// ═══════════════════════════════════════════════════════════════
//  UTILITIES
// ═══════════════════════════════════════════════════════════════

function showStatus(type, msg) {
  const el = document.getElementById('statusMsg');
  el.className = 'status show ' + type;
  el.innerHTML = msg;
}

// ═══════════════════════════════════════════════════════════════
//  DOWNLOAD PROTECTION
// ═══════════════════════════════════════════════════════════════

// Block right-click context menu on video area globally
document.getElementById('videoArea')?.addEventListener('contextmenu', e => e.preventDefault());

// Prevent drag-saving of video elements
document.addEventListener('dragstart', e => {
  if (e.target.tagName === 'VIDEO' || e.target.closest('.video-area')) {
    e.preventDefault();
  }
});

if (window.ethereum) {
  window.ethereum.on('accountsChanged', () => window.location.reload());
  window.ethereum.on('chainChanged', () => window.location.reload());
}
</script>
</body>
</html>
